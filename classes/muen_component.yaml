inherit: [gpr]

depends:
  - if: $(ne,${RTS:-UNSET},UNSET)
    name: ${RTS}
  - muen::common-gpr
  - muen::build-cfg-gpr

buildVars: [OBJCOPY, RTS, CROSS_COMPILE]
buildVarsWeak: [MAKE_JOBS]
buildSetup: |
  export GPR_TARGET="${CROSS_COMPILE%"-"}"
  export BUILD_CFG_PATH=${BOB_DEP_PATHS[muen::build-cfg-gpr]}
  if [[ ${MUEN_BUILD_MODE:-"0"} != "0" ]]; then
    export MUEN_BUILD_MODE=${MUEN_BUILD_MODE}
    if [[ ${MUEN_BUILD_MODE} == "test" ]]; then
      # arm64 on-target aunit tests use more Ada features.
      echo "Setting custom restrictions"
      export GLOBAL_RESTRICTIONS="restrictions-aunit.adc"
      export LOCAL_RESTRICTIONS="restrictions-prove.adc"
    fi
  fi
buildScript: |
  muenBuild() {
    gprbuild -P $1 \
      -j${MAKE_JOBS:-$(nproc)} \
      --relocate-build-tree=build \
      -gnatef -s -k \
      --create-map-file \
      --target=${GPR_TARGET} \
      ${RTS:+--RTS=${BOB_DEP_PATHS[${RTS}]}/usr/include/rts} \
      ${GPRBUILD_EXTRA_ARGS:-} \
      -largs "${LARGS[@]}" \
      -cargs "${CARGS[@]}"
    rm -rf install
    gprinstall -P $1 \
      --relocate-build-tree=build \
      --target=${GPR_TARGET} \
      --prefix="${PREFIX:-install/usr}" \
      -p \
      -f \
      ${@:2}
  }

  # $1 ELF file to use
  # If NO_SUFFIX variable is set, do not append .bin suffix
  muenBuildBin() {
    suffix=""
    [ -z "${NO_SUFFIX:-}" ] && suffix=".bin"

    pushd install/usr/bin
    ${OBJCOPY} -O binary \
      --set-section-flags .bss=alloc,load,contents \
      --set-section-flags .stack=alloc,load,contents \
      $1 ${1%.elf}$suffix
    popd
  }

  # $1 templates dir
  # $2 output file path
  muenStringTemplates () {
    mkdir -p $(dirname $2)
    echo "-- Auto-generated" > $2
    echo "package String_Templates is" >> $2
    echo "   pragma Style_Checks (Off);" >> $2
    for tmpl in $1/*; do
      echo "" >> $2
      echo -n $(basename $tmpl) | sed 's/templates\///g;s/\(\-\|\.\)/\_/g;' >> $2
      echo ' : constant String := ""' >> $2
      sed -e 's/"/""/g;s/^\(.*\)$/\& "\1" \& ASCII.LF/g' $tmpl >> $2
      echo '& "";' >> $2
    done
    echo 'end String_Templates;' >> $2
  }
