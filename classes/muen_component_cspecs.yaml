depends:
  - ${MUEN_POLICY_SRC}

buildTools: [mucfgcvresalloc, muxmlfilter, mucgenspec, libxslt-tools]
buildVars: [MUEN_POLICY_SRC]
buildSetup: |
  mkdir -p generated
  export GENERATED=$(pwd)/generated
  export __SRC=$1

  muenCspecs() {
    # FIXME remove handling if components are exported as well
    if [ -d ${__SRC}/components/${1}/spec ]; then
      DIR=${__SRC}/components/${1}/spec
    elif [ -d ${__SRC}/${1}/spec ]; then
      DIR=${__SRC}/${1}/spec
    else
      DIR=nonexistent
    fi

    SPEC=$DIR/${1}.xml
    if [ -e $DIR/${1}.xsl ]; then
      xsltproc -o generated/${1}.xml \
         $DIR/${1}.xsl \
         ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml
      SPEC=generated/${1}.xml
    fi

    if [ -e ${SPEC} ]; then
      # cspecs
      mucfgcvresalloc  ${SPEC} \
        generated/${1}.xml -I generated

      # Filter xml cspecs
      muxmlfilter -isn Component_Ext -osn Component \
        generated/${1}.xml generated/${1}_filtered.xml

      # Generate cspecs
      mucgenspec -i generated/${1}_filtered.xml \
                 generated
    fi
  }
