#
# usage:
#
#   bob dev | build demo-{TARGET_PLATFORM}-{TARGET_CONFIG}-{BUILD_MODE}
#     [-D MUEN_GDB_SUPPORT=enabled|disabled] with
#
#   - TARGET_PLATFORM: xilinx-zcu104 or qemu-zcu102
#   - TARGET_CONFIG: minimal or multicore
#   - BUILD_MODE: release, debug, test or prove
#   - MUEN_GDB_SUPPORT (optional): enabled or disabled (default), enabled
#     means disable SMMU to be able to use Xilinx on-board debugger
#
inherit: [muen-root]

environment:
  MUENBLOCK_BRANCH: "arm64"
  MUENBLOCK_COMMIT: "967d6b52f318bd9a8a397085b65047dfd6096660"

depends:
  # (1) Build all required tools depending on the build mode.
  - name: devel::dtc
    use: [tools]
    forward: True

  - name: devel::xilinx::bootgen
    use: [tools]

  - name: utils::dosfstools
    use: [tools]

  - name: utils::mtools
    use: [tools]
    forward: True

  - name: utils::uboot-tools
    use: [tools]

  - name: libs::glib-tools
    use: [tools]
    forward: True

  - name: utils::cpio
    use: [tools]
    forward: True

  # (2) Build an aarch64 linux gnu compiler with ada enabled, so that
  # the target toolchain for the following 'sub-depends' is aarch64-
  # linux-gnu- with ada support.
  - name: devel::cross-toolchain-aarch64-linux-gnu-ada
    use: [tools]
    forward: True
    tools:
      target-toolchain: host-compat-gnat-toolchain
      host-native-toolchain: host-compat-gnat-toolchain

  # (3) Build the Muen ARM64 kernel binary either with the standard Muen
  # rts or the arm64-rts-aunit with AUnit support for build mode 'test'.
  - depends:
    - if: !expr |
          "${MUEN_BUILD_MODE}" == "test"
      environment:
        RTS: "muen::arm64-rts-aunit"
      depends:
        - muen::arm64-kernel-${MUEN_BUILD_MODE}
        - muen::muenonarm-policy-files
    - if: !expr |
          "${MUEN_BUILD_MODE}" != "test"
      environment:
        RTS: "muen::rts"
      depends:
        - muen::arm64-kernel-${MUEN_BUILD_MODE}
        - muen::muenonarm-policy-files

  # (4) Build the bootloader binaries for exception level 3 (currently
  # prebuilt binaries depending on hardware from muenonarm repository).
  - if: !expr |
        "${MUEN_BUILD_MODE}" != "prove"
    depends:
    - muen::muenonarm-bootloader-binaries

  # (5) Build the VM subjects (i.e. Linux subjects) of the Muen SK system
  # for the build modes release and debug only (not required for the test
  # runner nor the proofs).
  - if: !expr |
        "${MUEN_BUILD_MODE}" == "release" || "${MUEN_BUILD_MODE}" == "debug"
    depends:
      - muen::linux-image
      - muen::muenonarm-devicetree
      - demo::rootfs

  # (6) Build the native subjects of the Muen SK system for the build
  # modes release and debug only (not required for the test runner nor
  # the proofs). Currently, the standard Muen rts is used as runtime.
  - if: !expr |
        "${MUEN_BUILD_MODE}" == "release" || "${MUEN_BUILD_MODE}" == "debug"
    environment:
      RTS: "muen::rts"
    depends:
      - muen::muenonarm-subjects-example
      - muen::muenonarm-subjects-event_logger

  # (7) Generate deployment scripts for all deploy modes.
  - if: !expr |
        "${MUEN_BUILD_MODE}" != "prove"
    depends:
      - muen::muenonarm-xsct-swboot-file
      - muen::muenonarm-gdb-xsct-files
      - muen::muenonarm-bootgen-files

  - if: !expr |
        "${MUEN_BUILD_MODE}" == "test"
    depends:
      - muen::muenonarm-uboot-tftp-files

buildTools: [mucheckelf, mugends, bootgen, mtools, dosfstools, uboot-tools]
buildVars: [MUEN_BUILD_MODE, TARGET_CONFIG, TARGET_PLATFORM]
buildScript: |
  case ${MUEN_BUILD_MODE} in
    release|debug)
      # (a) Copy the required build results of previous steps to support
      # all deploy modes (i.e. gdb, xsct, sdcard and u-boot tftp) and to
      # be able to use the mugends tool (TODO: mugends needs all our dep
      # in the CWD. Maybe we can extend the tool to handle multiple search
      # directories to avoid unnecessary copies.).
      cp ${BOB_DEP_PATHS[muen::muenonarm-bootloader-binaries]}/* .

      cp ${BOB_DEP_PATHS[muen::arm64-kernel-${MUEN_BUILD_MODE}]}/kernel.elf .
      cp ${BOB_DEP_PATHS[muen::arm64-kernel-${MUEN_BUILD_MODE}]}/kernel .
      cp ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/bin/* .

      cp ${BOB_DEP_PATHS[muen::muenonarm-devicetree]}/*.dtb .

      if [[ ${TARGET_CONFIG} == "minimal" ]] ; then
        cp ${BOB_DEP_PATHS[muen::linux-image]}/Image.bin Image_linux.bin
        cp ${BOB_DEP_PATHS[demo::rootfs]}/boot/initramfs.cpio.gz rootfs_linux.cpio.gz
      else
        cp ${BOB_DEP_PATHS[muen::linux-image]}/Image.bin Image_lnx1.bin
        cp ${BOB_DEP_PATHS[demo::rootfs]}/boot/initramfs.cpio.gz rootfs_lnx1.cpio.gz

        cp ${BOB_DEP_PATHS[muen::linux-image]}/Image.bin Image_lnx2.bin
        cp ${BOB_DEP_PATHS[demo::rootfs]}/boot/initramfs.cpio.gz rootfs_lnx2.cpio.gz
      fi

      if [[ ${TARGET_CONFIG} == minimal ]]; then
        cp ${BOB_DEP_PATHS[muen::muenonarm-subjects-event_logger]}/event_logger.bin subject_one.bin
      else
        cp ${BOB_DEP_PATHS[muen::muenonarm-subjects-example]}/example.bin subject_one.bin
      fi

      # (b) Validate the resulting kernel binary against the policy.
      mucheckelf ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/policy_b.xml ./kernel.elf

      # (c) Generate deployment scripts, binaries and images for all deploy
      # modes (i.e. gdb, xsct, sdcard and u-boot tftp) by first calling
      # mugends to generate the respective commands and then using these
      # files and bash commands from the legacy build system to generate
      # the required results.
      mugends -o . ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/policy_b.xml
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp ${BOB_DEP_PATHS[muen::muenonarm-xsct-swboot-file]}/xswboot.tcl .
      fi

      # (c.i) gdb / xsct
      cp ${BOB_DEP_PATHS[muen::muenonarm-gdb-xsct-files]}/gdbinit.gtp ./gdbinit
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        # overwrite gdbinit.config for hardware xsct deployment
        cp ${BOB_DEP_PATHS[muen::muenonarm-gdb-xsct-files]}/gdbinit.config .
      fi
      sed -i -e "/__GDB_MAIN__/{r $(pwd)/gdbinit.config" -e "d}" gdbinit

      # (c.ii) sdcard and qemu boot image
      cp ${BOB_DEP_PATHS[muen::muenonarm-bootgen-files]}/* .
      sed -i -e "/__BIF_MAIN__/{r $(pwd)/bootgen.config" -e "d}" bootgen.bif

      bootgen -arch zynqmp -image bootgen.bif -w -o BOOT.bin

      if [[ ${TARGET_PLATFORM} == qemu_zcu102 ]]; then
        dd if=/dev/zero of=sdcard.img bs=128M count=1
        mkfs.vfat -F 32 sdcard.img
        mcopy -i sdcard.img BOOT.bin ::/
      fi

      # (c.iii) u-boot tftp script
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        mkimage -A arm -O linux -T script -C none -a 0 -e 0 -n "Boot Script" -d bootscript.cmd bootscript.scr
      fi
      ;;

    test)
      # (a) Copy the required build results of previous steps to support
      # all deploy modes (i.e. gdb, xsct, sdcard and u-boot tftp)
      cp ${BOB_DEP_PATHS[muen::muenonarm-bootloader-binaries]}/* .
      cp ${BOB_DEP_PATHS[muen::arm64-kernel-${MUEN_BUILD_MODE}]}/kernel_test.elf .
      cp ${BOB_DEP_PATHS[muen::arm64-kernel-${MUEN_BUILD_MODE}]}/kernel_test kernel_test.bin

      # (c) Generate deployment scripts, binaries and images for all deploy
      # modes (i.e. gdb, xsct, sdcard and u-boot tftp)
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp ${BOB_DEP_PATHS[muen::muenonarm-xsct-swboot-file]}/xswboot.tcl .
      fi

      # (c.i) gdb / xsct
      cp ${BOB_DEP_PATHS[muen::muenonarm-gdb-xsct-files]}/gdbinit.gtp ./gdbinit
      sed -i -e "/__GDB_MAIN__/{r ${BOB_DEP_PATHS[muen::muenonarm-gdb-xsct-files]}/gdbinit_test.config" -e "d}" gdbinit

      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp ${BOB_DEP_PATHS[muen::muenonarm-gdb-xsct-files]}/xsct_test.tcl ./xsct.tcl
      fi

      # (c.ii) sdcard and qemu boot image
      cp ${BOB_DEP_PATHS[muen::muenonarm-bootgen-files]}/* .
      sed -i -e "/__BIF_MAIN__/{r $(pwd)/bootgen_test.config" -e "d}" bootgen.bif

      bootgen -arch zynqmp -image bootgen.bif -w -o BOOT.bin

      if [[ ${TARGET_PLATFORM} == qemu_zcu102 ]]; then
        dd if=/dev/zero of=sdcard.img bs=128M count=1
        mkfs.vfat -F 32 sdcard.img
        mcopy -i sdcard.img BOOT.bin ::/
      fi

      # (c.iii) u-boot tftp script
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp ${BOB_DEP_PATHS[muen::muenonarm-uboot-tftp-files]}/* .
        mkimage -A arm -O linux -T script -C none -a 0 -e 0 -n "Boot Script" -d bootscript_test.cmd bootscript.scr
      fi
      ;;

    prove)
      cp ${BOB_DEP_PATHS[muen::arm64-kernel-${MUEN_BUILD_MODE}]}/gnatprove.* .
      ;;
  esac

packageScript: |
  case ${MUEN_BUILD_MODE} in
    release|debug)
      # Build binaries
      cp $1/*.bit .
      cp $1/*.hdf .

      cp $1/kernel .
      cp $1/*.bin .
      cp $1/*.bin .
      cp $1/*.elf .
      cp $1/*.fill .
      cp $1/*.pad .
      cp $1/*.part .
      cp $1/*_pt .
      cp $1/*_sinfo .

      cp $1/*.dtb .
      cp $1/*.cpio.gz .

      # Deployment scripts (gdb / xsct, sdcard, tftp)
      cp $1/gdbinit .

      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/xswboot.tcl .
        cp $1/xsct.tcl .
        cp $1/bootscript.scr .
      fi

      if [[ ${TARGET_PLATFORM} == qemu_zcu102 ]]; then
        cp $1/sdcard.img .
      fi

      ;;
    test)
      # Build Binaries
      cp $1/*.bin .
      cp $1/*.elf .
      cp $1/*.bit .
      cp $1/*.hdf .

      # Deployment scripts (gdb / xsct, sdcard, tftp)
      cp $1/gdbinit .

      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/xswboot.tcl .
        cp $1/xsct.tcl .
        cp $1/bootscript.scr .
      fi

      if [[ ${TARGET_PLATFORM} == qemu_zcu102 ]]; then
        cp $1/sdcard.img .
      fi
      ;;
    prove)
      # Proof Results
      cp $1/gnatprove.* .
      ;;
  esac

multiPackage:
  qemu:
    multiPackage:
      zcu102:
        depends:
          - tools:
              target-toolchain: host-compat-toolchain
            depends:
              - name: devel::xilinx::qemu
                use: [tools]
              - devel::xilinx::qemu-devicetrees
        environment:
          TARGET_PLATFORM: "qemu_zcu102"
        multiPackage: &target_config
          minimal:
            environment:
              TARGET_CONFIG: "minimal"
            multiPackage: &muen_build_mode
              release:
                environment:
                  MUEN_BUILD_MODE: "release"
              debug:
                environment:
                  MUEN_BUILD_MODE: "debug"
              test:
                environment:
                  MUEN_BUILD_MODE: "test"
              prove:
                environment:
                  MUEN_BUILD_MODE: "prove"
          multicore:
            environment:
              TARGET_CONFIG: "multicore"
            multiPackage: *muen_build_mode
        packageToolsWeak: [qemu]

  xilinx:
    multiPackage:
      zcu104:
        environment:
          TARGET_PLATFORM: "xilinx_zcu104"
        multiPackage: *target_config
