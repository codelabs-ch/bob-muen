#build a minimal rootfs for the linuxes.

depends:
  - codelabs::adhcp-client
  - codelabs::adhcp-notifier-simple
  - core::busybox
  - demo::gnat-linux
  - libs::libc-tgt
  - net::ethtool
  - net::iperf
  - net::iptables
  - net::openssh
  - net::tcpdump
  - utils::bash
  - utils::e2fsprogs
  - utils::screen

  - if: "$(eq,${ROOTFS_ARCH:-},x86_64)"
    depends:
      - demo::pingpong
      - libs::lvm2
      - utils::cryptsetup
      - utils::mingetty
      - utils::s390-tools-ttyrun
      - utils::sysbench
      - utils::ttysnoop

  - name: muen::linux-modules
    use: [environment, result]
  - muen::muenblock
  - muen::muennet
  - muen::muenevents
  - muen::muenfs

  - demo::rootfs-content

  - name: kernel::kmod
    use: [tools]
    tools:
      target-toolchain: host-compat-toolchain

buildTools: [kmod]
buildVars: [LINUX_VERSION]
buildScript: |
  rm -rf rootfs .debug
  mkdir -p rootfs .debug

  for dep in "${BOB_DEP_PATHS[@]}"; do
     rsync -av --exclude ".debug" ${dep}/ rootfs/
     rsync -a ${dep}/ .debug/
  done

  pushd rootfs

  rm -r usr/lib/gconv

  # linux terminfo is required by clear command, remove everything else
  find usr/share/terminfo/ -mindepth 1 -maxdepth 1 -type d ! -name "l" -exec rm -r {} +
  find usr/share/terminfo/l -mindepth 1 -maxdepth 1 -type f ! -name "linux" -exec rm -r {} +

  ln -sf bin/busybox init
  ln -sf /usr/bin/bash bin/bash
  ln -sf /usr/bin/bash bin/sh

  # fake /dev/null for init process
  mkdir dev
  touch dev/null

  mkdir -p dev/pts etc mnt proc sys tmp
  mkdir -p var/log
  mkdir -p var/run
  mkdir -p etc/network/if-pre-up.d
  mkdir -p etc/network/if-up.d
  mkdir -p etc/network/if-down.d
  mkdir -p etc/network/if-post-down.d

  touch etc/fstab

  if [[ -d "lib/modules/${LINUX_VERSION}" ]]; then
      depmod -b "$PWD" "${LINUX_VERSION}"
  fi
  popd

packageTools: [cpio]
packageScript: |
  mkdir -p boot
  (
      cd $1/rootfs
      find . | sort | cpio --create --reproducible --format=newc --owner=root:root | gzip
  ) > boot/initramfs.cpio.gz
