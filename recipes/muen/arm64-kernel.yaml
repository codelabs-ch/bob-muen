inherit: [muen_component]

checkoutSCM:
  scm: git
  url: git@git.codelabs.ch:muen/arm64/kernel.git
  branch: e0b84541c054-bob
  commit: 1e6326aa76032b8b592bb217c18694d93de8eb48

depends:
  - muen::common-muschedinfo
  - muen::muenonarm-policy-files

buildTools: [mugenspec]
buildVars: [RTS]
buildSetup: |
  export GPR_RTS=${BOB_DEP_PATHS[${RTS}]}/usr/include/rts
  export SKP_DIR=$(pwd)/skp
buildScript: |
  rm -rf skp && mkdir -p skp
  mugenspec -o $(pwd)/skp ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/policy_b.xml

multiPackage:
  release:
    buildVars: [MUEN_GDB_SUPPORT]
    buildSetup: |
      export BUILD_MODE=release
      export GDB_SUPPORT=${MUEN_GDB_SUPPORT:-disabled}
    buildScript: |
      muenBuild $1/kernel.gpr
      muenBuildBin kernel.elf
    packageScript: |
      cp $1/install/usr/bin/* .
  debug:
    buildVars: [OBJCOPY, RTS, MUEN_GDB_SUPPORT]
    buildSetup: |
      export BUILD_MODE=debug
      export DEBUG_LEVEL=Level_5
      export GDB_SUPPORT=${MUEN_GDB_SUPPORT:-disabled}
    buildScript: |
      muenBuild $1/kernel.gpr
      muenBuildBin kernel.elf
    packageScript: |
      cp $1/install/usr/bin/* .
  test:
    depends:
      - adacore::aunit-dev
      - muen::muenonarm-test
    buildVars: [OBJCOPY, RTS, MUEN_GDB_SUPPORT]
    buildSetup: |
      export RTS_CONFIG=${BOB_DEP_PATHS[muen::muenonarm-test]}/rts-config
      export BUILD_MODE=test
      export GDB_SUPPORT=${MUEN_GDB_SUPPORT:-disabled}
    buildScript: |
      GPRBUILD_EXTRA_ARGS=("--implicit-with=aunit")
      muenBuild $1/kernel.gpr
      muenBuildBin kernel_test.elf
    packageScript: |
      cp $1/install/usr/bin/* .
  prove:
    buildVars: [RTS]
    buildSetup: |
      export BUILD_MODE=prove
    buildScript: |
      muenProve $1/kernel
      cp $1/obj/gnatprove/gnatprove.out .
    packageScript: |
      cp $1/gnatprove.out .
