inherit: [muen_component]

checkoutSCM:
  scm: git
  url: git@git.codelabs.ch:muen/arm64/kernel.git
  branch: e0b84541c054-bob
  commit: 1e6326aa76032b8b592bb217c18694d93de8eb48

depends:
  - muen::common-muschedinfo
  - muen::muenonarm-policy-files

buildTools: [mugenspec]
buildVars: [MUEN_GDB_SUPPORT, RTS]
buildSetup: |
  export GPR_RTS=${BOB_DEP_PATHS[${RTS}]}/usr/include/rts
  export SKP_DIR=$(pwd)/skp
  export GDB_SUPPORT=${MUEN_GDB_SUPPORT:-disabled}
  export BIN_POSTFIX=""
buildScript: |
  rm -rf skp && mkdir -p skp
  mugenspec -o $(pwd)/skp ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/policy_b.xml

multiPackage:
  release:
    buildSetup: |
      export BUILD_MODE=release
    buildScript: &common_build |
      muenBuild $1/kernel.gpr
      muenBuildBin kernel${BIN_POSTFIX}.elf
    packageScript: &common_pkg |
      cp $1/install/usr/bin/* .
  debug:
    buildSetup: |
      export BUILD_MODE=debug
      export DEBUG_LEVEL=Level_5
    buildScript: *common_build
    packageScript: *common_pkg
  test:
    depends:
      - adacore::aunit-dev
      - muen::muenonarm-test
    buildSetup: |
      export RTS_CONFIG=${BOB_DEP_PATHS[muen::muenonarm-test]}/rts-config
      export GPRBUILD_EXTRA_ARGS=("--implicit-with=aunit")
      export BUILD_MODE=test
      export BIN_POSTFIX=_test
    buildScript: *common_build
    packageScript: *common_pkg
  prove:
    buildVars: [RTS]
    buildSetup: |
      export BUILD_MODE=prove
    buildScript: |
      muenProve $1/kernel
      cp $1/obj/gnatprove/gnatprove.out .
    packageScript: |
      cp $1/gnatprove.out .
