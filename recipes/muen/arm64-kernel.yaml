checkoutSCM:
  scm: git
  url: git@git.codelabs.ch:muen/arm64/kernel.git
  branch: e0b84541c054-bob
  commit: 1e6326aa76032b8b592bb217c18694d93de8eb48

multiPackage:
  release:
    inherit: [muen_component]
    depends:
      - muen::common-muschedinfo
      - muen::muenonarm-policy-files
    buildTools: [mugenspec]
    buildVars: [OBJCOPY, MUEN_GDB_SUPPORT]
    buildSetup: |
      export GPR_RTS=${BOB_DEP_PATHS[muen::rts]}/usr/include/rts
      export SKP_DIR=$(pwd)/skp
      export BUILD_MODE=release
      export GDB_SUPPORT=${MUEN_GDB_SUPPORT:-disabled}
    buildScript: |
      rm -rf skp && mkdir -p skp
      mugenspec -o $(pwd)/skp ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/policy_b.xml
      muenBuild $1/kernel
      pushd install/usr/bin
      ${OBJCOPY} -O binary \
        --set-section-flags .bss=alloc,load,contents \
        --set-section-flags .stack=alloc,load,contents \
        kernel.elf kernel.bin
      popd
    packageScript: |
      cp $1/install/usr/bin/* .
  debug:
    inherit: [muen_component]
    depends:
      - muen::common-muschedinfo
      - muen::muenonarm-policy-files
    buildTools: [mugenspec]
    buildVars: [OBJCOPY, MUEN_GDB_SUPPORT]
    buildSetup: |
      export GPR_RTS=${BOB_DEP_PATHS[muen::rts]}/usr/include/rts
      export SKP_DIR=$(pwd)/skp
      export BUILD_MODE=debug
      export DEBUG_LEVEL=Level_5
      export GDB_SUPPORT=${MUEN_GDB_SUPPORT:-disabled}
    buildScript: |
      rm -rf skp && mkdir -p skp
      mugenspec -o $(pwd)/skp ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/policy_b.xml
      muenBuild $1/kernel
      pushd install/usr/bin
      ${OBJCOPY} -O binary \
        --set-section-flags .bss=alloc,load,contents \
        --set-section-flags .stack=alloc,load,contents \
        kernel.elf kernel.bin
      popd
    packageScript: |
      cp $1/install/usr/bin/* .
  test:
    inherit: [muen_component]
    depends:
      - muen::common-muschedinfo
      - muen::muenonarm-policy-files
      - adacore::aunit-dev
      - muen::muenonarm-test
    buildTools: [mugenspec]
    buildVars: [OBJCOPY, MUEN_GDB_SUPPORT]
    buildSetup: |
      export GPR_RTS=${BOB_DEP_PATHS[muen::arm64-rts-aunit]}/usr/include/rts/
      export RTS_CONFIG=${BOB_DEP_PATHS[muen::muenonarm-test]}/rts-config
      export SKP_DIR=$(pwd)/skp
      export BUILD_MODE=test
      export GDB_SUPPORT=${MUEN_GDB_SUPPORT:-disabled}
    buildScript: |
      rm -rf skp && mkdir -p skp
      mugenspec -o $(pwd)/skp ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/policy_b.xml
      GPRBUILD_EXTRA_ARGS=()
      GPRBUILD_EXTRA_ARGS+=("--implicit-with=aunit")
      muenBuild $1/kernel
      pushd install/usr/bin
      mv kernel_test.elf kernel.elf
      ${OBJCOPY} -O binary \
        --set-section-flags .bss=alloc,load,contents \
        --set-section-flags .stack=alloc,load,contents \
        kernel.elf kernel.bin
      popd
    packageScript: |
      cp $1/install/usr/bin/* .
  prove:
    inherit: [muen_component]
    depends:
      - muen::common-muschedinfo
      - muen::muenonarm-policy-files
    buildTools: [mugenspec]
    buildSetup: |
      export GPR_RTS=${BOB_DEP_PATHS[muen::rts]}/usr/include/rts
      export SKP_DIR=$(pwd)/skp
      export BUILD_MODE=prove
    buildScript: |
      rm -rf skp && mkdir -p skp
      mugenspec -o $(pwd)/skp ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/policy_b.xml
      gnatprove -P$1/kernel --warnings=error --report=all \
        --RTS=${BOB_DEP_PATHS[muen::rts]}/usr/include/rts \
        --target=$(GPR_TARGET) -XBUILD_MODE=prove \
        $(MUEN_PROVE_EXTRA_OPTIONS)
    packageScript: |
      cp $1/gnatprove.out .
