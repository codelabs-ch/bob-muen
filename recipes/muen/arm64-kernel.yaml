inherit: [muen_component]

checkoutSCM:
  scm: git
  url: https://git.codelabs.ch/muen/arm64/kernel.git
  branch: main
  commit: a4406c48a285ba6ca8f8b7de15828bf3b802c02f

depends:
  - muen::common-muschedinfo-dev
  - muen::arm64-systems-policy-files

buildTools: [mugenspec]
buildVars: [MUEN_GDB_SUPPORT, RTS, SYSTEM]
buildSetup: |
  export GPR_RTS=${BOB_DEP_PATHS[${RTS}]}/usr/include/rts
  export SKP_DIR=$(pwd)/skp
  export GDB_SUPPORT=${MUEN_GDB_SUPPORT:-disabled}
  export BIN_POSTFIX=""
buildScript: |
  rm -rf skp && mkdir -p skp
  mugenspec -o $(pwd)/skp ${BOB_DEP_PATHS[muen::arm64-systems-policy-files]}/${SYSTEM}_b.xml

multiPackage:
  release:
    buildSetup: |
      export BUILD_MODE=release
    buildScript: &common_build |
      muenBuild $1/kernel.gpr
      NO_SUFFIX=1 muenBuildBin kernel${BIN_POSTFIX}.elf
    packageScript: &common_pkg |
      cp $1/install/usr/bin/* .
  debug:
    buildSetup: |
      export BUILD_MODE=debug
    buildScript: *common_build
    packageScript: *common_pkg
  test:
    depends:
      - adacore::aunit-dev
      - muen::arm64-systems-test
    buildSetup: |
      export RTS_CONFIG=${BOB_DEP_PATHS[muen::arm64-systems-test]}
      export GPRBUILD_EXTRA_ARGS=("--implicit-with=aunit")
      export BUILD_MODE=test
      export BIN_POSTFIX=_test
    buildScript: *common_build
    packageScript: *common_pkg
  proof:
    inherit: [muen_proof]
    buildSetup: |
      export BUILD_MODE=prove
      export GPR_FILE=$1/kernel.gpr
      export GNATPROVE_EXTRA_ARGS="-XPREFIX=$(pwd)"
    buildScript: |
      muenProof
