inherit: [gpr]

checkoutSCM:
  scm: git
  url: https://git.codelabs.ch/muen/arm64/rts-aunit.git
  branch: main
  commit: b7f451eaeccbd0a4f555c09d1f1ace0d53dd627e

privateEnvironment:
  FP_SUPPORT: "true"

buildTools: [target-toolchain, gprbuild]
buildVars: [FP_SUPPORT]
buildScript: |
  # Note: out-of-tree build requires setting up the obj folder
  # structure correctly incl. copying the libgnat source files
  # into the adainclude folder and copying and preprocessing
  # the runtime.xml file.
  rsync -a --delete $1/ .
  mkdir -p obj/adainclude obj/adalib
  cp $1/src/libgnat/* obj/adainclude
  cp $1/src/runtime.xml obj
  if [[ "${FP_SUPPORT}" == false ]]; then
    sed -i 's/__FP_SUPPORT__/ , "-mgeneral-regs-only"/g' obj/runtime.xml
  else
    sed -i 's/__FP_SUPPORT__//g' obj/runtime.xml
  fi

  gprbuild -P rts_aunit \
    --target=aarch64-linux-gnu \
    --RTS=$(pwd)/obj \
    -XGPR_TARGET=aarch64-linux-gnu \
    --relocate-build-tree=build

  gprinstall -P rts_aunit \
    --relocate-build-tree=build \
    --target=aarch64-linux-gnu \
    --prefix=install/usr -p -f -m

packageScript: |
  mkdir -p usr/include/rts/adainclude
  mkdir -p usr/include/rts/adalib
  cp $1/install/usr/gnat/* usr/include/rts/adainclude
  cp $1/install/usr/adalib/* usr/include/rts/adalib
  cp $1/install/usr/runtime.xml usr/include/
