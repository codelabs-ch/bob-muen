checkoutSCM:
  scm: git
  url: git@git.codelabs.ch:muen/arm64/rts-aunit.git
  branch: rts-shared
  commit: a3c8c74ae19b63cb797bebd339845db4f9b21321

privateEnvironment:
  FP_SUPPORT: "true"

buildTools: [target-toolchain, gprbuild]
buildVars: [FP_SUPPORT]
buildScript: |
  # FIXME: OOT tree build is failing in gprinstall due to wrong path of
  # runtime.xml
  rsync -a --delete $1/ .
  mkdir -p obj/adainclude obj/adalib
  cp $1/src/libgnat/* obj/adainclude
  cp $1/src/runtime.xml obj
  if [[ "${FP_SUPPORT}" == false ]]; then
    sed -i 's/__FP_SUPPORT__/ , "-mgeneral-regs-only"/g' obj/runtime.xml
  else
    sed -i 's/__FP_SUPPORT__//g' obj/runtime.xml
  fi

  gprbuild -P zfp_aarch64 \
    --target=aarch64-linux-gnu \
    --RTS=$(pwd)/obj \
    -XGPR_TARGET=aarch64-linux-gnu \
    --relocate-build-tree=build

  gprinstall -Pzfp_aarch64 \
    --relocate-build-tree=build \
    --target=aarch64-linux-gnu \
    --prefix=install/usr -p -f -m

packageScript: |
  mkdir -p usr/include/rts/adainclude
  mkdir -p usr/include/rts/adalib
  cp $1/install/usr/gnat/* usr/include/rts/adainclude
  cp $1/install/usr/adalib/* usr/include/rts/adalib
  cp $1/install/usr/runtime.xml usr/include/
