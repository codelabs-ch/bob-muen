checkoutSCM:
  scm: git
  url: git@git.codelabs.ch:muen/arm64/systems.git
  branch: main
  commit: ed20f44ad91282849191c1a9c0d552ab01f09c1b

multiPackage:
  common:
    inherit: [muen_component]
    depends:
      - muen::arm64-systems-bsp
    buildSetup: |
      export BSP_DIR=${BOB_DEP_PATHS[muen::arm64-systems-bsp]}
    buildScript: |
      muenBuild $1/bsp/common/arm64_common
    packageScript: |
      gprInstallPackageDev
  bsp:
    buildVars: [CROSS_COMPILE, OBJCOPY, NAME, TARGET_CONFIG]
    buildTools: [target-toolchain]
    buildScript: |
      ${CROSS_COMPILE}gnatprep -v $1/bsp/platform/src/board.adb \
        board.adb \
        $1/bsp/config/${TARGET_CONFIG}/${NAME}/bsp.conf

      ${CROSS_COMPILE}gnatprep -v $1/bsp/platform/src/board.ads \
        board.ads \
        $1/bsp/config/${TARGET_CONFIG}/${NAME}/bsp.conf
      cp $1/bsp/platform/src/driver/* .
    packageScript: |
      rsync -a --delete $1/ .
  subjects:
    multiPackage:
      event_logger:
        inherit: [muen_component]
        depends:
          - name: muen::arm64-systems-common
            environment:
              NAME: "subject_one"
        buildVars: [OBJCOPY]
        buildScript: |
          muenBuild $1/subjects/event_logger/event_logger.gpr
          muenBuildBin event_logger.elf
        packageScript: |
          cp $1/install/usr/bin/event_logger.* .
      example:
        inherit: [muen_component]
        depends:
          - name: muen::arm64-systems-common
            environment:
              NAME: "subject_one"
          - muen::common-libmusinfo-dev
        buildVars: [OBJCOPY, NAME, TARGET_PLATFORM, TARGET_CONFIG]
        buildTools: [mucgenspec, target-toolchain]
        buildSetup: |
          export GEN_DIR=$(pwd)/generated
        buildScript: |
          mucgenspec -i $1/subjects/example/spec/example.xml \
              -p Example generated

          muenBuild $1/subjects/example/example.gpr
          muenBuildBin example.elf
        packageScript: |
          cp $1/install/usr/bin/example.* .

  bootloader-binaries:
    buildVars: [TARGET_PLATFORM]
    buildScript: |
      cp $1/deployment/${TARGET_PLATFORM}/common/bootloader/* .
    packageScript: |
      cp $1/* .

  bootgen-files:
    buildScript: |
      cp $1/deployment/common/bootgen/* .
    packageScript: |
      cp $1/* .

  gdb-xsct-files:
    buildVars: [TARGET_PLATFORM, TARGET_CONFIG]
    buildScript: |
      cp $1/deployment/${TARGET_PLATFORM}/common/gdb/gdbinit.gtp .
      cp $1/deployment/${TARGET_PLATFORM}/common/gdb/gdbinit_test.config .
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/deployment/${TARGET_PLATFORM}/common/gdb/xsct_test.tcl .
        cp $1/deployment/${TARGET_PLATFORM}/${TARGET_CONFIG}/gdb/gdbinit.config .
      fi
    packageScript: |
      cp $1/* .

  uboot-tftp-files:
    buildVars: [TARGET_PLATFORM]
    buildScript: |
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/deployment/${TARGET_PLATFORM}/common/uboot/bootscript_test.cmd .
      fi
    packageScript: |
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/* .
      fi

  xsct-swboot-file:
    buildVars: [TARGET_PLATFORM, TARGET_CONFIG]
    buildScript: |
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/deployment/${TARGET_PLATFORM}/common/xsct/xswboot.tcl .
      fi
    packageScript: |
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/* .
      fi

  linux-config:
    buildScript: |
      cp $1/linux/kernel.config .
    packageScript: |
      cp $1/* .

  devicetree:
    depends:
      - muen::arm64-systems-policy-files
      - muen::linux-dt-bindings
    buildTools: [mugendts, dtc, target-toolchain]
    buildVars: [CC]
    buildScript: |
      mugendts -o . ${BOB_DEP_PATHS[muen::arm64-systems-policy-files]}/policy_b.xml
      for F in *.dts; do
        F=$(basename ${F%.dts})
        ${CC} -I ${BOB_DEP_PATHS[muen::linux-dt-bindings]} -E \
          -nostdinc -undef -D__DTS__ -x assembler-with-cpp \
          -o  $(basename $F)-pre.dts $F.dts
        ARCH=arm64 dtc -I dts -O dtb \
          $(basename $F)-pre.dts \
          -o $(basename $F).dtb
      done
    packageScript: |
      rsync -a --delete $1/ .

  policy-files:
    inherit: [python3]
    depends:
      - muen::linux-image
      - muen::tools-libmupy
    buildTools: [mucfgcjoin, mucfgexpand, mucfgalloc, mucfgvalidate, mugenpt, mugensinfo]
    buildVars: [TARGET_CONFIG]
    buildScript: |
      rm -rf bin && mkdir bin

      # Determine effective Linux image size from header
      LINUX_SIZE=$(python3 - ${BOB_DEP_PATHS[muen::linux-image]}/Image.bin << EOF
      import os
      import sys
      import struct
      sys.path.append(os.getcwd() + "/tools/libmupy")
      import muutils
      with open(sys.argv[1], 'rb') as image:
        image.seek(16)
        size = struct.unpack("<Q", image.read(8))[0]
        size -= size % -4096
        print(muutils.int_to_ada_hex(size))
      EOF
      )

      # Build Linux cspec
      cat > linux.xml << EOF
      <component name="linux" profile="linux">
        <provides>
          <memory logical="binary" virtualAddress="16#0020_0000#" size="${LINUX_SIZE}" writable="true" executable="true" type="subject_binary">
            <file filename="Image.bin" offset="none"/>
          </memory>
        </provides>
      </component>
      EOF

      mucfgcjoin -i $1/policy/${TARGET_CONFIG}.xml \
        -c $1/subjects/example/spec/example.xml,linux.xml \
        -o policy_src.xml

      mucfgexpand policy_src.xml policy_a.xml

      mucfgalloc policy_a.xml policy_b.xml

      mucfgvalidate policy_b.xml

      mugenpt -o bin policy_b.xml

      mugensinfo -o bin policy_b.xml
    packageScript: |
      cp -r $1/* .

  test:
    buildVars: [TARGET_PLATFORM]
    buildScript: |
      cp $1/rts-aunit-config/common/* .
      cp $1/rts-aunit-config/${TARGET_PLATFORM}/* .
    packageScript: |
      cp -r $1/* .
