checkoutSCM:
  scm: git
  url: https://git.codelabs.ch/muen/arm64/systems.git
  branch: main
  commit: 9235360d07b7ff23456b5288ace864e1340fe909

multiPackage:
  common:
    inherit: [muen_component]
    depends:
      - muen::arm64-systems-bsp
    buildSetup: |
      export BSP_DIR=${BOB_DEP_PATHS[muen::arm64-systems-bsp]}
    buildScript: |
      muenBuild $1/bsp/common/arm64_common
    packageScript: |
      gprInstallPackageDev
  bsp:
    buildVars: [CROSS_COMPILE, OBJCOPY, NAME, SYSTEM]
    buildTools: [target-toolchain]
    buildScript: |
      ${CROSS_COMPILE}gnatprep -v $1/bsp/platform/src/board.adb \
        board.adb \
        $1/bsp/config/${SYSTEM}/${NAME}/bsp.conf

      ${CROSS_COMPILE}gnatprep -v $1/bsp/platform/src/board.ads \
        board.ads \
        $1/bsp/config/${SYSTEM}/${NAME}/bsp.conf
      cp $1/bsp/platform/src/driver/* .
    packageScript: |
      rsync -a --delete $1/ .
  subjects:
    multiPackage:
      event_logger:
        inherit: [muen_component]
        depends:
          - name: muen::arm64-systems-common
            environment:
              NAME: "subject_one"
        buildVars: [OBJCOPY]
        buildScript: |
          muenBuild $1/subjects/event_logger/event_logger.gpr
          muenBuildBin event_logger.elf
        packageScript: |
          cp $1/install/usr/bin/event_logger.* .
      example:
        inherit: [muen_component]
        depends:
          - name: muen::arm64-systems-common
            environment:
              NAME: "subject_one"
          - muen::component-libs-libmusinfo-dev
        buildVars: [OBJCOPY, NAME, SYSTEM, HARDWARE]
        buildTools: [mucgenspec, target-toolchain]
        buildSetup: |
          export GEN_DIR=$(pwd)/generated
        buildScript: |
          mucgenspec -i $1/subjects/example/spec/example.xml \
              -p Example generated

          ln -snf $1/subjects/example/spec/example.xml
          muenBuild $1/subjects/example/example.gpr
          muenBuildBin example.elf
        packageScript: |
          cp $1/install/usr/bin/example.* .
          mkdir -p usr/share/
          cp -L $1/example.xml usr/share
          mkdir -p .bob
          echo usr/share/example.xml > .bob/cspecs

  bootloader-binaries:
    buildVars: [HARDWARE]
    buildScript: |
      cp $1/deployment/${HARDWARE}/common/bootloader/* .
    packageScript: |
      cp $1/* .

  bootgen-files:
    buildScript: |
      cp $1/deployment/common/bootgen/* .
    packageScript: |
      cp $1/* .

  gdb-xsct-files:
    buildVars: [HARDWARE, SYSTEM]
    buildScript: |
      cp $1/deployment/${HARDWARE}/common/gdb/gdbinit.gtp .
      cp $1/deployment/${HARDWARE}/common/gdb/gdbinit_test.config .
      if [[ ${HARDWARE} == xilinx-zcu104 ]]; then
        cp $1/deployment/${HARDWARE}/common/gdb/xsct_test.tcl .
        cp $1/deployment/${HARDWARE}/${SYSTEM}/gdb/gdbinit.config .
      fi
    packageScript: |
      cp $1/* .

  uboot-tftp-files:
    buildVars: [HARDWARE]
    buildScript: |
      if [[ ${HARDWARE} == xilinx-zcu104 ]]; then
        cp $1/deployment/${HARDWARE}/common/uboot/bootscript_test.cmd .
      fi
    packageScript: |
      if [[ ${HARDWARE} == xilinx-zcu104 ]]; then
        cp $1/* .
      fi

  xsct-swboot-file:
    buildVars: [HARDWARE]
    buildScript: |
      if [[ ${HARDWARE} == xilinx-zcu104 ]]; then
        cp $1/deployment/${HARDWARE}/common/xsct/xswboot.tcl .
      fi
    packageScript: |
      if [[ ${HARDWARE} == xilinx-zcu104 ]]; then
        cp $1/* .
      fi

  linux-config:
    buildScript: |
      cp $1/linux/kernel.config .
    packageScript: |
      cp $1/* .

  devicetree:
    depends:
      - muen::arm64-systems-policy
      - muen::linux-dt-bindings
    buildTools: [mugendts, dtc, target-toolchain]
    buildVars: [CC, SYSTEM]
    buildScript: |
      mugendts -o . ${BOB_DEP_PATHS[muen::arm64-systems-policy]}/${SYSTEM}_b.xml
      for F in *.dts; do
        F=$(basename ${F%.dts})
        ${CC} -I ${BOB_DEP_PATHS[muen::linux-dt-bindings]} -E \
          -nostdinc -undef -D__DTS__ -x assembler-with-cpp \
          -o  $(basename $F)-pre.dts $F.dts
        ARCH=arm64 dtc -I dts -O dtb \
          $(basename $F)-pre.dts \
          -o $(basename $F).dtb
      done
    packageScript: |
      rsync -a --delete $1/ .

  policy-src:
    inherit: [muen_policy_src]
    buildScript: muenPolicySrcCreate $1
    packageScript: muenPolicySrcPackage $1

  policy:
    environment:
      ARCH: arm64
    inherit: [python3, muen_policy]
    depends:
      - muen::linux-image
      - environment:
          RTS: "muen::rts"
        depends:
          - muen::arm64-systems-subjects-event_logger
          - if: "$(eq,${SYSTEM:-},multicore)"
            depends:
              - muen::arm64-systems-subjects-example
              - muen::components-dbgserver
    buildTools:
      - mugenpt
      - mugensinfo
    buildVars: [SYSTEM, HARDWARE, PLATFORM]
    buildScript: |
      # Determine effective Linux image size from header
      LINUX_SIZE=$(python3 - ${BOB_DEP_PATHS[muen::linux-image]}/Image.bin << EOF
      import os
      import sys
      import struct
      sys.path.append(os.getcwd() + "/tools/libmupy")
      import muutils
      with open(sys.argv[1], 'rb') as image:
        image.seek(16)
        size = struct.unpack("<Q", image.read(8))[0]
        size -= size % -4096
        print(muutils.int_to_ada_hex(size))
      EOF
      )

      # Build Linux cspec
      cat > linux.xml << EOF
      <component name="linux" profile="linux">
        <provides>
          <memory logical="binary" virtualAddress="16#0020_0000#" size="${LINUX_SIZE}" writable="true" executable="true" type="subject_binary">
            <file filename="Image.bin" offset="none"/>
          </memory>
        </provides>
      </component>
      EOF
      ADDITIONAL_CSPECS="$(pwd)/linux.xml"

      muenPolicyRun "${SYSTEM}" "${HARDWARE}" "${PLATFORM}" "${ADDITIONAL_CSPECS}"
    provideDeps: ['*']

  test:
    buildVars: [HARDWARE]
    buildScript: |
      cp $1/rts-aunit-config/common/* .
      cp $1/rts-aunit-config/${HARDWARE}/* .
    packageScript: |
      cp -r $1/* .
