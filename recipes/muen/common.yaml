checkoutSCM:
  scm: git
  url: https://git.codelabs.ch/muen/common.git
  branch: $(if-then-else,$(eq,${ARCH},arm64),devel-armv8a-8c50d03ff97e-bob,devel-93c2e7735aac-bob)
  commit: $(if-then-else,$(eq,${ARCH},arm64),bd47a596284f170be45ddb8522a25140c1fbc19e,0adce842164a9647b73f4f89d1cca14a855f8637)

multiPackage:
  gpr:
    inherit: [gpr]

    buildVars: [ARCH]
    buildScript: |
      if [[ ${ARCH} == x86_64 ]]; then
        rsync -a --delete $1/gpr .
      fi
    packageScript: |
      if [[ ${ARCH} == x86_64 ]]; then
        gprInstallPackageDev $1/gpr
      fi

  "":
    inherit: [muen_component]
    multiPackage:
      debug:
        depends:
          - muen::common-common-dev
          - muen::common-strings-dev
          - muen::common-crash_audit-dev
        buildVars: [COMMON_DEBUG_WITHOUT_UART_STATE]
        buildScript: |
          muenBuild $1/debug/common_debug
        multiPackage: &common_dev_tgt_provides
          dev:
            provideDeps: ['*-dev']
            packageScript: gprInstallPackageDev
          tgt:
            provideDeps: ['*-tgt']
            packageScript: gprInstallPackageTgt
      crash_audit:
        depends:
          - muen::common-common-dev
        buildScript: muenBuild $1/crash_audit/crash_audit
        multiPackage: *common_dev_tgt_provides
      common:
        depends:
          - ${ISR_ENTRIES}
        privateEnvironment:
          GPR_PATH: "src/muen_common"
        buildVars: [ISR_ENTRIES, GPR_PATH]
        buildScript: |
          export ISR_ENTRIES_DIR="${BOB_DEP_PATHS[${ISR_ENTRIES}]}"
        multiPackage:
          "":
            buildScript: |
              muenBuild $1/${GPR_PATH}
            multiPackage: &common_dev_tgt
              dev:
                packageScript: gprInstallPackageDev
              tgt:
                packageScript: gprInstallPackageTgt
          proof: &common_proof
            inherit: [muen_proof]
            buildSetup: |
              export GPR_FILE=$1/${GPR_PATH}
              export MUEN_BUILD_MODE=prove
              export OBJ_DIR=$(pwd)/obj/
              export LIB_DIR=$(pwd)/lib/
            buildScript: |
              muenProof
      strings:
        depends:
          - muen::common-common-dev
        privateEnvironment:
          GPR_PATH: "strings/common_strings"
        buildVars: [GPR_PATH]
        multiPackage:
          "":
            buildScript: |
              muenBuild $1/${GPR_PATH}
            multiPackage: *common_dev_tgt_provides
          proof: *common_proof

      muinterrupts:
        buildScript: |
          muenBuild $1/muinterrupts/muinterrupts
        multiPackage: *common_dev_tgt

      musinfo:
        buildScript: |
          muenBuild $1/musinfo/musinfo
        multiPackage: *common_dev_tgt

      muschedinfo:
        buildScript: |
          muenBuild $1/muschedinfo/muschedinfo
        multiPackage: *common_dev_tgt

      mutimedevents:
        buildScript: |
          muenBuild $1/mutimedevents/mutimedevents
        multiPackage: *common_dev_tgt

      libmusinfo:
        depends:
          - muen::common-musinfo-dev
          - muen::common-muschedinfo-dev
          - use: []
            depends:
              - muen::common-musinfo-tgt
              - muen::common-muschedinfo-tgt
        privateEnvironment:
          GPR_PATH: "libmusinfo/libmusinfo"
        buildVars: [GPR_PATH]
        multiPackage:
          "":
            buildScript: |
              rm -rf install
              muenBuild $1/${GPR_PATH}
            multiPackage:
              dev:
                provideDeps: ['*-dev']
                packageScript: gprInstallPackageDev
              tgt:
                provideDeps: ['*-tgt']
                packageScript: gprInstallPackageTgt
          proof: *common_proof
