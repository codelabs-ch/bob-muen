checkoutSCM:
  scm: git
  url: ${MUEN_COMMON_URL:-https://git.codelabs.ch/muen/common.git}
  branch: ${MUEN_COMMON_BRANCH:-devel-arm64-crash-audit}
  commit: ${MUEN_COMMON_COMMIT:-02bc5acf2801a39e4fa4648e31d54209c1f6cebe}

multiPackage:
  gpr:
    inherit: [gpr]
    buildScript: |
      rsync -a --delete $1/gpr .
    packageScript: |
      gprInstallPackageDev $1/gpr

  "":
    inherit: [muen_component]
    buildVars: [ARCH, MUEN_BUILD_MODE]
    multiPackage:
      debug:
        depends:
          - muen::common-common-dev
          - muen::common-strings-dev
          - muen::common-crash_audit-dev
        buildVars: [MUEN_COMMON_VARIANT]
        buildScript: |
          muenBuild $1/debug/common_debug
        multiPackage: &common_dev_tgt_provides
          dev:
            provideDeps: ['*-dev']
            packageScript: gprInstallPackageDev
          tgt:
            provideDeps: ['*-tgt']
            packageScript: gprInstallPackageTgt
      crash_audit:
        depends:
          - muen::common-common-dev
        buildVars: [MUEN_COMMON_VARIANT]
        buildScript: muenBuild $1/crash_audit/crash_audit
        multiPackage: *common_dev_tgt_provides
      common:
        privateEnvironment:
          GPR_PATH: "src/muen_common"
        buildVars: [ARCH, GPR_PATH, MUEN_COMMON_VARIANT]
        multiPackage:
          "":
            buildScript: |
              muenBuild $1/${GPR_PATH}
            multiPackage: &common_dev_tgt
              dev:
                packageScript: gprInstallPackageDev
              tgt:
                packageScript: gprInstallPackageTgt
          proof: &common_proof
            inherit: [muen_proof]
            buildSetup: |
              export GPR_FILE=$1/${GPR_PATH}
              export MUEN_BUILD_MODE=prove
              export OBJ_DIR=$(pwd)/obj/
              export LIB_DIR=$(pwd)/lib/
            buildScript: |
              muenProof
      strings:
        depends:
          - muen::common-common-dev
        privateEnvironment:
          GPR_PATH: "strings/common_strings"
        buildVars: [GPR_PATH, MUEN_COMMON_VARIANT]
        multiPackage:
          "":
            buildScript: |
              muenBuild $1/${GPR_PATH}
            multiPackage: *common_dev_tgt_provides
          proof: *common_proof

      muinterrupts:
        buildVars: [MUEN_COMMON_VARIANT]
        buildScript: |
          muenBuild $1/muinterrupts/muinterrupts
        multiPackage: *common_dev_tgt

      musinfo:
        buildVars: [MUEN_COMMON_VARIANT]
        buildScript: |
          muenBuild $1/musinfo/musinfo
        multiPackage: *common_dev_tgt

      muschedinfo:
        buildVars: [MUEN_COMMON_VARIANT]
        buildScript: |
          muenBuild $1/muschedinfo/muschedinfo
        multiPackage: *common_dev_tgt

      mutimedevents:
        buildVars: [MUEN_COMMON_VARIANT]
        buildScript: |
          muenBuild $1/mutimedevents/mutimedevents
        multiPackage: *common_dev_tgt
