inherit: [muen_component]

checkoutSCM:
  scm: git
  url: https://git.codelabs.ch/muen/components.git
  branch: main
  commit: e1366f680da4145eeec4d917e31f3a8c8964a8ff

multiPackage:
  "":
    environment:
      MUEN_COMMON_VARIANT: "component"
    buildVars: [MUEN_BUILD_MODE]
    depends:
      - name: muen::common-common-dev

    multiPackage:
      ahci_drv:
        depends:
          - muen::component-libmubase-dev
          - muen::component-libs-libmuchannel-dev
          - muen::component-libs-libmudebuglog-dev
          - muen::component-libs-libmublock-dev
          - muen::common-strings-dev
          - use: []
            depends:
              - muen::component-libs-libmudebuglog-tgt
        multiPackage:
          "":
            inherit: [muen_component_app]
            buildScript: |
              muenBuildApp ahci_drv
            packageScript: |
              muenInstallApp ahci_drv
            provideDeps: ['*-tgt']
          proof:
            inherit: [muen_proof_app]
            environment:
              RTS: "muen::rts"
              COMPONENT_NAME: "ahci_drv"
              GPR_PATH: "ahci_drv/ahci_drv"

      controller:
        depends:
          - muen::component-libmubase-dev
          - muen::component-libs-libmucontroltypes-dev
          - muen::component-libs-libmudebuglog-dev
          - muen::common-muinterrupts-dev
          - muen::common-strings-dev
          - use: []
            depends:
              - muen::component-libs-libmucontrol-tgt
              - muen::component-libs-libmudebuglog-tgt
        multiPackage:
          "":
            inherit: [muen_component_app]
            buildScript: |
              muenBuildApp controller
            packageScript: |
              muenInstallApp controller
            provideDeps: ['*-tgt']
          proof:
            inherit: [muen_proof_app]
            environment:
              RTS: "muen::rts"
              COMPONENT_NAME: "controller"
              GPR_PATH: "controller/controller"

      dbgserver:
        multiPackage:
          config-dev:
            depends:
              - muen::build-cfg-scripts
              - ${MUEN_POLICY_SRC}
            buildVars: [MUEN_POLICY_SRC]
            buildTools: [libxslt-tools]
            buildScript: |
              mkdir -p install/usr/share
              xsltproc -o install/usr/share/dbg_config.gpr \
                      --stringparam GPRNAME dbg_config \
                      --stringparam COMPONENTNAME dbgserver \
                      --path ${BOB_DEP_PATHS[muen::build-cfg-scripts]}/ \
                      $1/dbgserver/misc/gpr.xsl \
                      ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml
            packageScript: |
              gprInstallPackageDev
          "":
            inherit: [python3, muen_component_app]
            depends:
              - muen::component-libmubase-dev
              - muen::components-dbgserver-config-dev
              - muen::component-libs-libmucoll-dev
              - muen::component-libs-libmutime-dev
              - muen::component-libs-libmudebuglog-dev
              - muen::common-debug-dev
              - muen::common-crash_audit-dev
              - muen::common-strings-dev
              - libs::libxhcidbg-dev
              - muen::build-cfg-scripts

              - name: python::lxml
                tools:
                  target-toolchain: host-compat-toolchain
              - use: []
                depends:
                  - muen::component-libs-libmudebuglog-tgt
                  - muen::component-libs-libmutime-tgt
                  - libs::libxhcidbg-tgt
            buildVars: [MUEN_POLICY_SRC]
            buildTools: [libxslt-tools]
            buildScript: |
              # generate dbg-subject_list.ads
              $1/dbgserver/misc/extract-subject-names.py \
                --out generated/dbg-subject_list.ads \
                --src_policy ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml

              # generate logchannels.xml
              xsltproc -o generated/logchannels.xml \
                       --stringparam COMPONENTNAME dbgserver \
                       $1/dbgserver/misc/logchannels.xsl \
                       ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml

              # generate subject_consoles.xml
              xsltproc -o generated/subject_consoles.xml \
                       --stringparam COMPONENTNAME dbgserver \
                       $1/dbgserver/misc/subject_consoles.xsl \
                       ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml

              # generate config.xml
              xsltproc -o generated/config.xml \
                       --stringparam COMPONENTNAME dbgserver \
                       --path ${BOB_DEP_PATHS[muen::build-cfg-scripts]}/ \
                       $1/dbgserver/misc/config.xsl \
                       ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml

              muenBuildApp dbgserver
            packageScript: |
              muenInstallApp dbgserver
            provideDeps: ['*-tgt']

      dm:
        depends:
          - muen::component-libmubase-dev
          - muen::component-libs-libmudm-dev
          - muen::component-libs-libmudebuglog-dev
          - muen::common-strings-dev
          - use: []
            depends:
              - muen::component-libs-libmudm-tgt
              - muen::component-libs-libmudebuglog-tgt
        multiPackage:
          "":
            inherit: [muen_component_app]
            buildScript: |
              muenBuildApp dm
            packageScript: |
              muenInstallApp dm
            provideDeps: ['*-tgt']
          proof:
            inherit: [muen_proof_app]
            environment:
              RTS: "muen::rts"
              COMPONENT_NAME: "dm"
              GPR_PATH: "dm/dm"

      example:
        multiPackage:
          config-dev:
            depends:
              - ${MUEN_POLICY_SRC}
              - muen::build-cfg-scripts
            buildVars: [MUEN_POLICY_SRC]
            buildTools: [libxslt-tools]
            buildScript: |
              mkdir -p install/usr/share
              xsltproc -o install/usr/share/example_config.gpr \
                      --stringparam GPRNAME example_config \
                      --path ${BOB_DEP_PATHS[muen::build-cfg-scripts]}/ \
                      $1/example/misc/gpr.xsl \
                      ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml
            packageScript: |
              gprInstallPackageDev

          "":
            depends:
              - muen::components-example-config-dev
              - muen::component-libs-libmublock-dev
              - muen::component-libs-libmucoll-dev
              - muen::component-libs-libmucontrol-dev
              - muen::component-libs-libmudebuglog-dev
              - muen::common-crash_audit-dev
              - muen::common-debug-dev
              - muen::common-mutimedevents-dev
              - muen::common-strings-dev
              - muen::component-libmubase-dev
              - use: []
                depends:
                  - muen::component-libs-libmucontrol-tgt
                  - muen::component-libs-libmudebuglog-tgt
            multiPackage:
              "":
                inherit: [muen_component_app]
                buildScript: |
                  muenBuildApp example
                packageScript: |
                  muenInstallApp example
                provideDeps: ['*-tgt']
              proof:
                inherit: [muen_proof_app]
                environment:
                  RTS: "muen::rts"
                  COMPONENT_NAME: "example"
                  GPR_PATH: "example/example"

      idle:
        depends:
          - muen::component-libmubase-dev
        inherit: [muen_component_app]
        buildScript: |
          muenBuildApp idle
        packageScript: |
          muenInstallApp idle

      isolation_tests:
        inherit: [muen_component_app, python3]
        depends:
          - muen::common-strings-dev
          - muen::component-libmubase-dev
          - muen::component-libs-libmusinfo-dev
          - muen::component-libs-libmudebuglog-dev
          - muen::tools-libmupy
          - use: []
            depends:
              - muen::component-libs-libmudebuglog-tgt
          - name: python::lxml
            tools:
              target-toolchain: host-compat-toolchain
        buildScript: |
          # Generate reference_values.ads
          $1/isolation_tests/misc/reference_values.py \
            --out generated/reference_values.ads \
            --src_policy ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml
          muenBuildApp isolation_tests
        packageScript: |
          muenInstallApp isolation_tests
        provideDeps: ['*-tgt']

      isolation_tests_monitor:
        inherit: [muen_component_app]
        depends:
          - muen::common-strings-dev
          - muen::component-libmubase-dev
          - muen::component-libs-libmusinfo-dev
          - muen::component-libs-libmucoll-dev
          - muen::component-libs-libmudebuglog-dev
          - use: []
            depends:
              - muen::component-libs-libmudebuglog-tgt
        buildScript: |
          muenBuildApp isolation_tests_monitor
        packageScript: |
          muenInstallApp isolation_tests_monitor
        provideDeps: ['*-tgt']

      ps2_drv:
        inherit: [muen_component_app]
        depends:
          - muen::component-libmubase-dev
          - muen::common-strings-dev
          - muen::component-libs-libmucoll-dev
          - muen::component-libs-libmudebuglog-dev
          - use: []
            depends:
              - muen::component-libs-libmudebuglog-tgt
        buildScript: |
          muenBuildApp ps2_drv
        packageScript: |
          muenInstallApp ps2_drv
        provideDeps: ['*-tgt']

      sl:
        depends:
          - muen::component-libmubase-dev
          - muen::component-libs-libmusinfo-dev
          - muen::component-libs-libmuinit-dev
          - use: []
            depends:
              - muen::component-libs-libmuinit-tgt
        multiPackage:
          "":
            inherit: [muen_component_app]
            buildScript: |
              muenBuildApp sl
            packageScript: |
              muenInstallApp sl
          proof:
            inherit: [muen_proof_app]
            environment:
              RTS: "muen::rts"
              COMPONENT_NAME: "sl"
              GPR_PATH: "sl/sl"

      sm:
        multiPackage:
          config-dev:
            depends:
              - muen::build-cfg-scripts
              - ${MUEN_POLICY_SRC}
            buildVars: [MUEN_POLICY_SRC]
            buildTools: [libxslt-tools]
            buildScript: |
              mkdir -p install/usr/share
              xsltproc -o install/usr/share/config.gpr \
                      --stringparam GPRNAME config \
                      --stringparam COMPONENTNAME config \
                      --path ${BOB_DEP_PATHS[muen::build-cfg-scripts]}/ \
                      $1/sm/misc/gpr.xsl \
                      ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml
            packageScript: |
              gprInstallPackageDev
          "":
            inherit: [python3]
            depends:
              - muen::common-strings-dev
              - muen::component-libmubase-dev
              - muen::component-libs-libmucoll-dev
              - muen::component-libs-libmucontrol-dev
              - muen::component-libs-libmudebuglog-dev
              - muen::component-libs-libmudm-dev
              - muen::component-libs-libmutime-dev
              - muen::components-sm-config-dev
              - muen::build-cfg-scripts

              - name: python::lxml
                tools:
                  target-toolchain: host-compat-toolchain
              - use: []
                depends:
                  - muen::component-libs-libmucontrol-tgt
                  - muen::component-libs-libmudebuglog-tgt
                  - muen::component-libs-libmudm-tgt
                  - muen::component-libs-libmutime-tgt
            buildTools: [libxslt-tools]
            buildVars: [MUEN_POLICY_SRC]
            buildScript: |
              rm -rf generated && mkdir -p generated
              # Generate cpu_values-target.ads
              $1/sm/misc/cpu-values.py \
                --out generated/cpu_values-target.ads \
                --src_policy ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml

              # generate config.xml
              xsltproc -o generated/config.xml \
                       --stringparam COMPONENTNAME sm \
                       --path ${BOB_DEP_PATHS[muen::build-cfg-scripts]}/ \
                       $1/sm/misc/config.xsl \
                       ${BOB_DEP_PATHS[${MUEN_POLICY_SRC}]}/policy_src.xml
            multiPackage:
              "":
                inherit: [muen_component_app]
                buildScript: |
                  muenBuildApp sm
                packageScript: |
                  muenInstallApp sm
                provideDeps: ['*-tgt']
              proof:
                inherit: [muen_proof_app]
                environment:
                  RTS: "muen::rts"
                  COMPONENT_NAME: "sm"
                  GPR_PATH: "sm/sm"

      tau0:
        inherit: [muen_component_app]
        depends:
          - muen::x86-kernel-policy
          - muen::component-libmubase-dev
        buildSetup: |
          export POLICY_DIR=${BOB_DEP_PATHS[muen::x86-kernel-policy]}
        buildScript: muenBuildApp tau0
        packageVars: [OBJCOPY]
        packageScript: |
          ${OBJCOPY} -O binary \
            --set-section-flags .bss=alloc,load,contents \
            --set-section-flags .stack=alloc,load,contents \
            $1/install/usr/bin/tau0 tau0

      time:
        inherit: [muen_component_app]
        depends:
          - muen::component-libmubase-dev
          - muen::common-strings-dev
          - muen::component-libs-libmusinfo-dev
          - muen::component-libs-libmudebuglog-dev
          - muen::component-libs-libmucontrol-dev
          - muen::component-libs-libmucoll-dev
          - muen::component-libs-libmutime-dev
          - use: []
            depends:
              - muen::component-libs-libmucontrol-tgt
              - muen::component-libs-libmudebuglog-tgt
              - muen::component-libs-libmutime-tgt
        multiPackage:
          "":
            buildScript: |
              muenBuildApp time
            packageScript: |
              muenInstallApp time
            provideDeps: ['*-tgt']
          proof:
            inherit: [muen_proof_app]
            environment:
              RTS: "muen::rts"
              COMPONENT_NAME: "time"
              GPR_PATH: "time/time"

      vt:
        inherit: [muen_component_app]
        depends:
          - muen::component-libmubase-dev
          - muen::common-debug-dev
          - muen::common-strings-dev
          - muen::component-libs-libmusinfo-dev
          - muen::component-libs-libmudebuglog-dev
          - muen::component-libs-libmutime-dev
          - muen::component-libs-libmucoll-dev
          - muen::component-libs-libmucontrol-dev
          - use: []
            depends:
              - muen::component-libs-libmucontrol-tgt
              - muen::component-libs-libmudebuglog-tgt
              - muen::component-libs-libmutime-tgt
        buildScript: |
          muenBuildApp vt
        packageScript: |
          muenInstallApp vt
        provideDeps: ['*-tgt']
