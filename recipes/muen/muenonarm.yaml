checkoutSCM:
  scm: git
  url: git@git.codelabs.ch:muenonarm.git
  branch: e2c0c01862fa-bob
  commit: 0c8fecc4ad75d639c5e5a65eedff46800d9f8da7

multiPackage:
  common:
    inherit: [muen_component]
    depends:
      - muen::muenonarm-bsp
    buildSetup: |
      export BSP_DIR=${BOB_DEP_PATHS[muen::muenonarm-bsp]}
    buildScript: |
      muenBuild $1/system/common/common
    packageScript: |
      gprInstallPackageDev
  bsp:
    buildVars: [CROSS_COMPILE, OBJCOPY, NAME, TARGET_PLATFORM, TARGET_CONFIG]
    buildTools: [target-toolchain]
    buildScript: |
      ${CROSS_COMPILE}gnatprep -v $1/system/platform/src/board.adb \
        board.adb \
        $1/system/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/subjects/native/${NAME}/bsp.conf

      ${CROSS_COMPILE}gnatprep -v $1/system/platform/src/board.ads \
        board.ads \
        $1/system/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/subjects/native/${NAME}/bsp.conf
      cp $1/system/platform/src/driver/* .
    packageScript: |
      rsync -a --delete $1/ .
  subjects:
    multiPackage:
      event_logger:
        inherit: [muen_component]
        depends:
          - name: muen::muenonarm-common
            environment:
              NAME: "subject_one"
        buildVars: [OBJCOPY]
        buildScript: |
          muenBuild $1/system/subjects/native/event_logger/event_logger.gpr
          muenBuildBin event_logger.elf
        packageScript: |
          cp $1/install/usr/bin/event_logger.* .
      example:
        inherit: [muen_component]
        depends:
          - name: muen::muenonarm-common
            environment:
              NAME: "subject_one"
          - muen::common-libmusinfo-dev
        buildVars: [OBJCOPY, NAME, TARGET_PLATFORM, TARGET_CONFIG]
        buildTools: [mucgenspec, target-toolchain]
        buildSetup: |
          export GEN_DIR=$(pwd)/generated
        buildScript: |
          mucgenspec -i $1/system/subjects/native/example/spec/example.xml \
              -p Example generated

          muenBuild $1/system/subjects/native/example/example.gpr
          muenBuildBin example.elf
        packageScript: |
          cp $1/install/usr/bin/example.* .

  bootloader-binaries:
    buildVars: [TARGET_PLATFORM]
    buildScript: |
      cp $1/dev/demo/src/${TARGET_PLATFORM}/common/bootloader/* .
    packageScript: |
      cp $1/* .

  bootgen-files:
    buildVars: [TARGET_PLATFORM, TARGET_CONFIG]
    buildScript: |
      cp $1/dev/demo/src/${TARGET_PLATFORM}/common/bootgen/bootgen.bif .
      cp $1/dev/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/deployment/packaged/bootgen_test.config .
    packageScript: |
      cp $1/* .

  gdb-xsct-files:
    buildVars: [TARGET_PLATFORM, TARGET_CONFIG]
    buildScript: |
      cp $1/dev/demo/src/${TARGET_PLATFORM}/common/gdb/gdbinit.gtp .
      cp $1/dev/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/deployment/gdb/gdbinit_test.config .
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/dev/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/deployment/gdb/gdbinit.config .
        cp $1/dev/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/deployment/gdb/xsct_test.tcl .
      fi
    packageScript: |
      cp $1/* .

  uboot-tftp-files:
    buildVars: [TARGET_PLATFORM, TARGET_CONFIG]
    buildScript: |
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/dev/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/deployment/uboot/bootscript_test.cmd .
      fi
    packageScript: |
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/* .
      fi

  xsct-swboot-file:
    buildVars: [TARGET_PLATFORM, TARGET_CONFIG]
    buildScript: |
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/dev/demo/src/${TARGET_PLATFORM}/common/xsct/xswboot.tcl .
      fi
    packageScript: |
      if [[ ${TARGET_PLATFORM} == xilinx_zcu104 ]]; then
        cp $1/* .
      fi

  devicetree:
    depends:
      - muen::muenonarm-policy-files
      - muen::linux-dt-bindings
    buildTools: [mugendts, dtc, target-toolchain]
    buildVars: [CC]
    buildScript: |
      mugendts -o . ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/policy_b.xml
      for F in *.dts; do
        F=$(basename ${F%.dts})
        ${CC} -I ${BOB_DEP_PATHS[muen::linux-dt-bindings]} -E \
          -nostdinc -undef -D__DTS__ -x assembler-with-cpp \
          -o  $(basename $F)-pre.dts $F.dts
        ARCH=arm64 dtc -I dts -O dtb \
          $(basename $F)-pre.dts \
          -o $(basename $F).dtb
      done
    packageScript: |
      rsync -a --delete $1/ .

  linux-config:
    buildScript: |
      cp $1/system/demo/src/qemu_zcu102/minimal/subjects/linux/kernel.config .
    packageScript: |
      cp $1/* .

  test:
    buildVars: [TARGET_CONFIG, TARGET_PLATFORM, MUEN_BUILD_MODE]
    buildScript: |
      mkdir -p rts-config
      cp $1/system/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/kernel/${MUEN_BUILD_MODE}/reset_values.ads ./rts-config
      cp $1/system/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/kernel/rts/* ./rts-config
    packageScript: |
      cp -r $1/* .

  policy-files:
    buildTools: [mucfgcjoin, mucfgexpand, mucfgalloc, mucfgvalidate, mugenpt, mugensinfo]
    buildVars: [TARGET_CONFIG]
    buildScript: |
      rm -rf bin && mkdir bin

      mucfgcjoin -i $1/system/demo/src/policy/${TARGET_CONFIG}.xml \
        -c $1/system/subjects/native/example/spec/example.xml \
        -o policy_src.xml

      mucfgexpand policy_src.xml policy_a.xml

      mucfgalloc policy_a.xml policy_b.xml

      mucfgvalidate policy_b.xml

      mugenpt -o bin policy_b.xml

      mugensinfo -o bin policy_b.xml
    packageScript: |
      cp -r $1/* .
