checkoutSCM:
  scm: git
  url: git@git.codelabs.ch:muenonarm.git
  branch: 043c43873376-bob
  commit: d3ad0f092d2fd05f749a564b6b9afb772d6e4d93

multiPackage:
  common:
    inherit: [muen_component]
    depends:
      - muen::muenonarm-bsp
    buildSetup: |
      export BSP_DIR=${BOB_DEP_PATHS[muen::muenonarm-bsp]}
    buildScript: |
      muenBuild $1/system/common/common
    packageScript: |
      gprInstallPackageDev
  bsp:
    buildVars: [CROSS_COMPILE, OBJCOPY, NAME, TARGET_PLATFORM, TARGET_CONFIG]
    buildTools: [target-toolchain]
    buildScript: |
      ${CROSS_COMPILE}gnatprep -v $1/system/platform/src/board.adb \
        board.adb \
        $1/system/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/subjects/native/${NAME}/bsp.conf

      ${CROSS_COMPILE}gnatprep -v $1/system/platform/src/board.ads \
        board.ads \
        $1/system/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/subjects/native/${NAME}/bsp.conf
      cp $1/system/platform/src/driver/* .
    packageScript: |
      rsync -a --delete $1/ .
  subjects:
    multiPackage:
      event_logger:
        inherit: [muen_component]
        depends:
          - name: muen::muenonarm-common
            environment:
              NAME: "subject_one"
        buildVars: [OBJCOPY]
        buildScript: |
          muenBuild $1/system/subjects/native/event_logger/event_logger

          pushd install/usr/bin
          ${OBJCOPY} -O binary --set-section-flags .bss=alloc,load,contents \
                    --set-section-flags .stack=alloc,load,contents \
                    event_logger.elf event_logger.bin
        packageScript: |
          cp $1/install/usr/bin/event_logger.* .
      example:
        inherit: [muen_component]
        depends:
          - name: muen::muenonarm-common
            environment:
              NAME: "subject_one"
          - muen::common-musinfo
          - muen::common-muschedinfo
          - muen::common-libmusinfo
        buildVars: [OBJCOPY, NAME, TARGET_PLATFORM, TARGET_CONFIG]
        buildTools: [mucgenspec, target-toolchain]
        buildSetup: |
          export GEN_DIR=$(pwd)/generated
        buildScript: |
          mucgenspec -i $1/system/subjects/native/example/spec/example.xml \
              -p Example generated

          muenBuild $1/system/subjects/native/example/example

          pushd install/usr/bin
          ${OBJCOPY} -O binary --set-section-flags .bss=alloc,load,contents \
                    --set-section-flags .stack=alloc,load,contents \
                    example.elf example.bin

        packageScript: |
          cp $1/install/usr/bin/example.* .

  bootgen_files:
    buildVars: [TARGET_PLATFORM, TARGET_CONFIG]
    buildScript: |
      rsync -a --delete $1/dev/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/deployment/packaged/ .
      cp $1/dev/demo/src/${TARGET_PLATFORM}/common/bootgen/* .
      cp $1/dev/demo/src/${TARGET_PLATFORM}/common/bootloader/* .
    packageScript: |
      cp $1/* .

  devicetree:
    depends:
      - muen::muenonarm-policy-files
      - muen::linux-dt-bindings
    buildTools: [mugendts, dtc, target-toolchain]
    buildVars: [CC]
    buildScript: |
      mugendts -o . ${BOB_DEP_PATHS[muen::muenonarm-policy-files]}/policy_b.xml
      for F in *.dts; do
        F=$(basename ${F%.dts})
        ${CC} -I ${BOB_DEP_PATHS[muen::linux-dt-bindings]} -E \
          -nostdinc -undef -D__DTS__ -x assembler-with-cpp \
          -o  $(basename $F)-pre.dts $F.dts
        ARCH=arm64 dtc -I dts -O dtb \
          $(basename $F)-pre.dts \
          -o $(basename $F).dtb
      done
    packageScript: |
      rsync -a --delete $1/ .

  linux-config:
    buildScript: |
      cp $1/system/demo/src/qemu_zcu102/minimal/subjects/linux/kernel.config .
    packageScript: |
      cp $1/* .

  test:
    buildVars: [TARGET_CONFIG, TARGET_PLATFORM, MUEN_BUILD_MODE]
    buildScript: |
      mkdir -p rts-config
      cp $1/system/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/kernel/${MUEN_BUILD_MODE}/reset_values.ads ./rts-config
      cp $1/system/demo/src/${TARGET_PLATFORM}/${TARGET_CONFIG}/kernel/rts/* ./rts-config
    packageScript: |
      cp -r $1/* .

  policy-files:
    buildTools: [mucfgjoin, mucfgexpand, mucfgalloc, mucfgvalidate, mugenpt, mugensinfo]
    buildVars: [TARGET_CONFIG]
    buildScript: |
      rm -rf bin && mkdir bin

      mucfgcjoin -i $1/system/demo/src/policy/${TARGET_CONFIG}.xml \
        -c $1/system/subjects/native/example/spec/example.xml \
        -o policy_src.xml

      mucfgexpand policy_src.xml policy_a.xml

      mucfgalloc policy_a.xml policy_b.xml

      mucfgvalidate policy_b.xml

      mugenpt -o bin policy_b.xml

      mugensinfo -o bin policy_b.xml
    packageScript: |
      cp -r $1/* .
