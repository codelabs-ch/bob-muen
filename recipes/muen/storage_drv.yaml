inherit: [muen_component]

metaEnvironment:
  PD: "Muen Storage Drv"
  LICENCE: "GPL-3.0-or-later [secunet,codelabs]"
  COPYRIGHT: "Copyright (C) 2020 secunet Security Networks AG\n
    Copyright (C) 2014-2021  Reto Buerki <reet@codelabs.ch>\n
    Copyright (C) 2014-2021  Adrian-Ken Rueegsegger <ken@codelabs.ch>"

checkoutSCM:
  - scm: git
    url: git@git.codelabs.ch:muen/storage_drv.git
    branch: main

environment:
  ISR_ENTRIES: "muen::x86-kernel-components-isr_entries"

multiPackage:
  "":
    inherit: [muen_component_app]
    depends:
      - muen::common-common-dev
      - muen::storage_drv-cspecs
      #- muen::libmusinfo-dev
      - muen::x86-kernel-components-libmuchannel-dev
      - muen::x86-kernel-components-libmudebuglog-dev
      - muen::x86-kernel-components-libmutime-dev
      - use: []
        depends:
          - muen::x86-kernel-components-libmudebuglog-tgt
    buildVars: [MUEN_STORAGE_BASE_DIR, MUEN_STORAGE_DRV_PORTS_CFG_OVERRIDE]
    buildSetup: |
      export BASE_DIR=${MUEN_STORAGE_BASE_DIR:-$(pwd)/src}
      export MUEN_STORAGE_DRV_CSPECS=${BOB_DEP_PATHS['muen::storage_drv-cspecs']}
      export MUEN_STORAGE_DRV_PORTS_CFG=${MUEN_STORAGE_DRV_PORTS_CFG_OVERRIDE:-${BOB_DEP_PATHS['muen::storage_drv-cspecs']}}
      export DRIVE_KIND="NVME"

    buildScript: |
      # prepare sources
      if [[ ${MUEN_STORAGE_BASE_DIR:-unset} == unset ]]; then
      mkdir -p src
      pushd src
      #tar xf ${BOB_DEP_PATHS['muen::storage_drv']}/*.tar
      popd
      fi
      CSPECS_PATH=${MUEN_STORAGE_DRV_CSPECS}

    multiPackage:
      "":
        buildScript: |
          muenBuildStorageDrv storage_drv
        provideDeps: ["*-tgt"]
        packageScript: |
          muenInstallStorageDrv storage_drv

      proof:
        inherit: [muen_component_app]
        environment:
          RTS: "muen::rts"
          COMPONENT_NAME: "storage_drv"
          GPR_PATH: "storage_drv/storage_drv"

  cspecs:
    inherit: [muen_component_cspecs]
    buildVars: [SLOTS, STORAGE_PORT]
    buildScript: |
      muenCspecsStorageDrv storage_drv
      #muenBuild $1/src/storage_drv.gpr
      #xsltproc -o ports_config.ads $1/src/src/ports_config.ads policy-src.xml
      # packageScript: |
      #   mlpPackageCspecs
      #   cp $1/ports_config.ads .
