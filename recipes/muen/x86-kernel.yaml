inherit: [muen_component]

checkoutSCM:
  scm: git
  url: ${MUEN_X86_KNL_URL:-https://git.codelabs.ch/muen.git}
  branch: ${MUEN_X86_KNL_BRANCH:-devel}
  commit: ${MUEN_X86_KNL_COMMIT:-377335576569839b32fc53a228e71788e0deab43}

multiPackage:
  "":
    depends:
      - environment:
          MUEN_COMMON_VARIANT: "kernel"
        depends:
          - muen::common-common-dev
          - muen::common-crash_audit-dev
          - if: "$(eq,${MUEN_BUILD_MODE:-},debug)"
            name: muen::common-debug-dev
          - muen::common-muinterrupts-dev
          - muen::common-muschedinfo-dev
          - muen::common-mutimedevents-dev
          - muen::common-strings-dev

      - muen::x86-kernel-policy
      - muen::components-tau0
    buildVars: [MUEN_BUILD_MODE]
    buildSetup: |
      export linker_script=$1/kernel/kernel.ld
      export POLICY_SRC_DIR=${BOB_DEP_PATHS[muen::x86-kernel-policy]}
      export VERSION_DIR=$(pwd)/_version
      mkdir -p $(pwd)/_version
      cat > _version/sk-version.ads << EOF
      --D @Interface
      --D Muen version information.
      package SK.Version is
         Version_String : constant String :=
           "$(git -C $1 describe --always --dirty="-UNCLEAN")";
      end SK.Version;
      EOF

    multiPackage:
      "":
        buildScript: |
          GPR_FILE=kernel
          if [[ ${MUEN_BUILD_MODE} == debug ]]; then
            GPR_FILE+=_debug
          fi
          muenBuild $1/kernel/$GPR_FILE
        provideDeps: ['muen::x86-kernel-policy', '*tau0']
        packageVars: [OBJCOPY]
        packageScript: |
          ${OBJCOPY} -O binary --set-section-flags .bss=alloc,load,contents \
            --set-section-flags .stack=alloc,load,contents \
            $1/install/usr/bin/kernel \
            kernel
          mkdir .debug
          cp $1/install/usr/bin/kernel .debug/

      metrics:
        buildTools: [libadalang-tools]
        buildScript: |
          # gnatmetric ignores files from Externally_Built libs, an attribute
          # which is set to True by gprinstall-created GPR files.
          # Copy all relevant lib deps here and create simple GPR file.
          for d in ${!BOB_DEP_PATHS[@]}; do
            DIR=${BOB_DEP_PATHS[$d]}
            if [ -e ${DIR}/usr/share/gpr/*.gpr ]; then
              # remove dependency from project path first
              GPR_PROJECT_PATH=$(echo "$GPR_PROJECT_PATH" | tr ':' '\n' | grep -v '$DIR' | paste -sd ':' -)

              gpr_name=$(basename ${DIR}/usr/share/gpr/*.gpr)
              include_name=$(basename ${DIR}/usr/include/*)
              echo "dependency found in: ${DIR}"
              mkdir -p deps
              cp -r ${DIR}/usr/include/* deps
          cat > deps/${gpr_name} << EOF
          project ${include_name} is
             for Source_Dirs use ("${include_name}");
          end ${include_name};
          EOF
            fi
          done

          GPR_PROJECT_PATH=deps:$GPR_PROJECT_PATH \
            OBJ_DIR="${PWD}/" \
            gnatmetric -v --output-dir=. -P$1/kernel/kernel > gnatmetric.log 2>&1
        packageScript: |
          cp $1/gnatmetric.log .

      proof:
        inherit: [muen_proof]
        environment:
          RTS: "muen::rts"
        buildSetup: |
          export GPR_FILE=$1/kernel/kernel.gpr
          export MUEN_BUILD_MODE=prove
          export OBJ_DIR=$(pwd)/
        buildScript: |
          muenProof

  ##########################################################################

  policy:
    inherit: [python3]
    depends:
      - bsp::intel::microcode
      - muen::linux-image
      - muen::component-libs-muinit
      - muen::components-ahci_drv
      - muen::components-controller
      - muen::components-dbgserver
      - muen::components-dm
      - muen::components-example
      - muen::components-idle
      - muen::components-isolation_tests
      - muen::components-isolation_tests_monitor
      - muen::components-ps2_drv
      - muen::components-sl
      - muen::components-sm
      - muen::components-time
      - muen::components-vt

      - ${MUEN_POLICY_SRC}

      - muen::x86-systems-linux-component-spec

      - name: demo::rootfs
        environment:
          ROOTFS_ARCH: "x86_64"

      - muen::tools-libmupy
      - name: python::lxml
        tools:
          target-toolchain: host-compat-toolchain
      - name: utils::iucode-tool
        use: [tools]
        tools:
          target-toolchain: host-compat-toolchain
    buildTools:
      - acpica
      - iucode-tool
      - linux-gencspec
      - mucfgalloc
      - mucfgcjoin
      - mucfgexpand
      - mucfgucode
      - mucfgvresalloc
      - muxmlfilter
      - mugenspec
      - mugensolo5
      - mugenzp
      - mugenmsrstore
      - mugenacpi
      - mucfgvalidate
    buildVars: [SYSTEM, HARDWARE, PLATFORM, MUEN_POLICY_SRC]
    buildScript: |
      # build the linux cspecs
      linux-gencspec \
        ${BOB_DEP_PATHS[muen::linux-image]}/boot/bzImage \
        ${BOB_DEP_PATHS[muen::x86-systems-linux-component-spec]}/linux.xml \
        --out_spec linux.xml \
        --src_policy ${BOB_DEP_PATHS[$MUEN_POLICY_SRC]}/${SYSTEM}.xml
      # --initramfs ${BOB_DEP_PATHS[demo::rootfs]}/boot/initramfs.cpio.gz \

      CSPECS="$(pwd)/linux.xml"
      # collect dependencies cspecs
      for dep_name in ${!BOB_DEP_PATHS[@]}; do
        dep_dir=${BOB_DEP_PATHS[${dep_name}]}
        if [[ -e ${dep_dir}/.bob/cspecs ]]; then
          CSPECS+=${CSPECS:+,}${dep_dir}/$(cat ${dep_dir}/.bob/cspecs)
        fi
      done
      # Join
      mucfgcjoin -i ${BOB_DEP_PATHS[$MUEN_POLICY_SRC]}/${SYSTEM}.xml \
        -o ${SYSTEM}_with_comp.xml \
        -c ${CSPECS}

      # Allocate virtual memory
      mucfgvresalloc ${SYSTEM}_with_comp.xml ${SYSTEM}_va.xml

      # Filter to core schema
      muxmlfilter -isn Format_Src_Ext -osn Format_Src ${SYSTEM}_va.xml \
        ${SYSTEM}_with_va_filtered.xml

      # MCU
      mucfgucode -i ${SYSTEM}_with_va_filtered.xml \
        -u ${BOB_DEP_PATHS['bsp::intel::microcode']} -o .

      # Expand
      mucfgexpand ${SYSTEM}_with_va_filtered.xml ${SYSTEM}_a.xml

      # Allocate physical memory
      mucfgalloc ${SYSTEM}_a.xml ${SYSTEM}_b.xml

      # Validate
      mucfgvalidate ${SYSTEM}_b.xml

      GENERATORS=(mugenspec mugensolo5 mugenzp mugenmsrstore mugenacpi)
      for G in ${GENERATORS[@]}; do
        $G -o  $(pwd) ${SYSTEM}_b.xml
      done

    provideDeps: ['*']
    packageScript: |
      rsync -a --delete $1/ .
      echo "GPR_PROJECT_PATH=." >> .gpr_project
