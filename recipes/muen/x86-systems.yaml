checkoutSCM:
  scm: git
  url: https://git.codelabs.ch/muen/x86/systems.git
  branch: main
  commit: 6569ef923b2617460ef62477c65e487a87667679

multiPackage:
  bootloader-cfg:
    buildScript: |
      cp $1/bootloader/grub* .
      cp -r $1/bootloader/keys .
      cp $1/bootloader/menu.lst .
    packageScript: |
      cp -r $1/* .

  linux-config:
    inherit: [kconfig]
    buildVars: [LINUX_KASAN, LINUX_CONFIG]
    buildScript: |
      cp $1/linux/config/${LINUX_CONFIG} .
      kconfigDisable CONFIG_LOCALVERSION ${LINUX_CONFIG}

      if [[ ${LINUX_KASAN:-UNSET} != UNSET ]]; then
        kconfigEnable CONFIG_KASAN ${LINUX_CONFIG}
      fi
    packageScript: |
      cp $1/* .

  linux-config-unipi:
    inherit: [kconfig]
    buildVars: [LINUX_CONFIG]
    buildScript: |
      cp $1/linux/config/${LINUX_CONFIG} .
      kconfigDisable CONFIG_LOCALVERSION ${LINUX_CONFIG}

      echo 'CONFIG_NETFILTER_XT_MATCH_U32=m' >> ${LINUX_CONFIG}
      echo 'CONFIG_BRIDGE_NETFILTER=m' >> ${LINUX_CONFIG}
    packageScript: |
      cp $1/* .

  linux-component-spec:
    buildScript: |
      cp $1/linux/spec/linux.xml .
    packageScript: |
      cp $1/* .

  policy-src:
    inherit: [muen_policy]
    buildScript: muenCreatePolicySrc $1
    packageScript: muenPackagePolicySrc $1

  policy-src-solo5:
    checkoutSCM:
      scm: url
      url: file://${UNIKERNEL_FILE:-Please specify UNIKERNEL_FILE!}
      dir: uni
    inherit: [muen_policy, solo5]
    buildVars: [UNIKERNEL_FILE]
    buildScript: |
      solo5ComposeConfig $1 $1/uni/$(basename $UNIKERNEL_FILE) \
          --channel-size 0x4000000
      muenCreatePolicySrc $1
    packageScript: |
      muenPackagePolicySrc $1
      fname=$(basename $UNIKERNEL_FILE)
      cp $1/$fname ./$fname

  policy-src-solo5-test:
    inherit: [muen_policy, solo5]
    depends:
      - devel::solo5-hello-muen
    buildScript: |
      solo5ComposeConfig $1 \
        ${BOB_DEP_PATHS[devel::solo5-hello-muen]}/test_hello.muen \
        --disable-reset \
        --bootparams "Hi!"
      muenCreatePolicySrc $1
    packageScript: |
      muenPackagePolicySrc $1
      cp $1/test_hello.muen .
