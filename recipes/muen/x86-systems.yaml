checkoutSCM:
  scm: git
  url: https://git.codelabs.ch/muen/x86/systems.git
  branch: main
  commit: d762b93affb57d9ae373e94b1f2d9d711f0d7c44

multiPackage:
  bootloader-cfg:
    buildScript: |
      cp $1/bootloader/grub* .
      cp -r $1/bootloader/keys .
      cp $1/bootloader/menu.lst .
    packageScript: |
      cp -r $1/* .

  linux-config:
    inherit: [kconfig]
    buildVars: [LINUX_KASAN, LINUX_CONFIG]
    buildScript: |
      cp $1/linux/config/${LINUX_CONFIG} .
      kconfigDisable CONFIG_LOCALVERSION ${LINUX_CONFIG}

      if [[ ${LINUX_KASAN:-UNSET} != UNSET ]]; then
        kconfigEnable CONFIG_KASAN ${LINUX_CONFIG}
      fi
    packageScript: |
      cp $1/* .

  linux-config-unipi:
    inherit: [kconfig]
    buildVars: [LINUX_CONFIG]
    buildScript: |
      cp $1/linux/config/${LINUX_CONFIG} .
      kconfigDisable CONFIG_LOCALVERSION ${LINUX_CONFIG}

      echo 'CONFIG_NETFILTER_XT_MATCH_U32=m' >> ${LINUX_CONFIG}
      echo 'CONFIG_BRIDGE_NETFILTER=m' >> ${LINUX_CONFIG}
    packageScript: |
      cp $1/* .

  linux-component-spec:
    buildScript: |
      cp $1/linux/spec/linux.xml .
    packageScript: |
      cp $1/* .

  policy-src:
    inherit: [muen_policy_src]
    buildScript: muenPolicySrcCreate $1
    packageScript: muenPolicySrcPackage $1

  policy-src-solo5:
    checkoutSCM:
      scm: url
      url: file://${UNIKERNEL_FILE:-Please specify UNIKERNEL_FILE!}
      dir: uni
    inherit: [muen_policy_src, solo5]
    buildVars: [UNIKERNEL_FILE]
    buildScript: |
      solo5ComposeConfig $1 $1/uni/$(basename $UNIKERNEL_FILE) \
          --channel-size 0x4000000
      muenPolicySrcCreate $1
    packageScript: |
      muenPolicySrcPackage $1
      fname=$(basename $UNIKERNEL_FILE)
      cp $1/$fname ./$fname

  policy-src-solo5-test:
    inherit: [muen_policy_src, solo5]
    depends:
      - devel::solo5-hello-muen
    buildScript: |
      solo5ComposeConfig $1 \
        ${BOB_DEP_PATHS[devel::solo5-hello-muen]}/test_hello.muen \
        --disable-reset \
        --bootparams "Hi!"
      muenPolicySrcCreate $1
    packageScript: |
      muenPolicySrcPackage $1
      cp $1/test_hello.muen .

  policy:
    inherit: [python3, muen_policy]
    depends:
      - bsp::intel::microcode
      - muen::linux-image
      - muen::component-libs-muinitstub
      - muen::components-ahci_drv
      - muen::components-controller
      - muen::components-dbgserver
      - muen::components-dm
      - muen::components-example
      - muen::components-idle
      - muen::components-isolation_tests
      - muen::components-isolation_tests_monitor
      - muen::components-ps2_drv
      - muen::components-sl
      - muen::components-sm
      - muen::components-time
      - muen::components-vt

      - muen::x86-systems-linux-component-spec

      - name: demo::rootfs
        environment:
          ROOTFS_ARCH: "x86_64"

      - name: python::lxml
        tools:
          target-toolchain: host-compat-toolchain
      - name: utils::iucode-tool
        use: [tools]
        tools:
          target-toolchain: host-compat-toolchain
    buildTools:
      - acpica
      - iucode-tool
      - linux-gencspec
      - mucfgucode
      - mugensolo5
      - mugenzp
      - mugenmsrstore
      - mugenacpi
    buildVars: [SYSTEM, HARDWARE, PLATFORM]
    buildScript: |
      # build the linux cspecs
      linux-gencspec \
        ${BOB_DEP_PATHS[muen::linux-image]}/boot/bzImage \
        ${BOB_DEP_PATHS[muen::x86-systems-linux-component-spec]}/linux.xml \
        --out_spec linux.xml \
        --src_policy ${BOB_DEP_PATHS[$MUEN_POLICY_SRC]}/${SYSTEM}.xml
      # --initramfs ${BOB_DEP_PATHS[demo::rootfs]}/boot/initramfs.cpio.gz
      ADDITIONAL_CSPECS="$(pwd)/linux.xml"

      muenPolicyRun "${SYSTEM}" "${HARDWARE}" "${PLATFORM}" "${ADDITIONAL_CSPECS}"
    provideDeps: ['*']
