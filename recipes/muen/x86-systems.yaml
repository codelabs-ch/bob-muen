checkoutSCM:
  scm: git
  url: https://git.codelabs.ch/muen/x86/systems.git
  branch: main
  commit: 6569ef923b2617460ef62477c65e487a87667679

multiPackage:
  bootloader-cfg:
    buildScript: |
      cp $1/bootloader/grub* .
      cp -r $1/bootloader/keys .
      cp $1/bootloader/menu.lst .
    packageScript: |
      cp -r $1/* .

  linux-config:
    inherit: [kconfig]
    buildVars: [LINUX_KASAN, LINUX_CONFIG]
    buildScript: |
      cp $1/linux/config/${LINUX_CONFIG} .
      kconfigDisable CONFIG_LOCALVERSION ${LINUX_CONFIG}

      if [[ ${LINUX_KASAN:-UNSET} != UNSET ]]; then
        kconfigEnable CONFIG_KASAN ${LINUX_CONFIG}
      fi
    packageScript: |
      cp $1/* .

  linux-config-unipi:
    inherit: [kconfig]
    buildVars: [LINUX_CONFIG]
    buildScript: |
      cp $1/linux/config/${LINUX_CONFIG} .
      kconfigDisable CONFIG_LOCALVERSION ${LINUX_CONFIG}

      echo 'CONFIG_NETFILTER_XT_MATCH_U32=m' >> ${LINUX_CONFIG}
      echo 'CONFIG_BRIDGE_NETFILTER=m' >> ${LINUX_CONFIG}
    packageScript: |
      cp $1/* .

  linux-component-spec:
    buildScript: |
      cp $1/linux/spec/linux.xml .
    packageScript: |
      cp $1/* .

  policy-src:
    inherit: [muen_policy]
    buildScript: muenCreatePolicySrc $1
    packageScript: muenPackagePolicySrc $1

  policy-src-solo5:
    checkoutSCM:
      scm: url
      url: file://${UNIKERNEL_FILE:-Please specify UNIKERNEL_FILE!}
      dir: uni
    inherit: [muen_policy, solo5]
    buildVars: [UNIKERNEL_FILE]
    buildScript: |
      solo5ComposeConfig $1 $1/uni/$(basename $UNIKERNEL_FILE) \
          --channel-size 0x4000000
      muenCreatePolicySrc $1
    packageScript: |
      muenPackagePolicySrc $1
      fname=$(basename $UNIKERNEL_FILE)
      cp $1/$fname ./$fname

  policy-src-solo5-test:
    inherit: [muen_policy, solo5]
    depends:
      - devel::solo5-hello-muen
    buildScript: |
      solo5ComposeConfig $1 \
        ${BOB_DEP_PATHS[devel::solo5-hello-muen]}/test_hello.muen \
        --disable-reset \
        --bootparams "Hi!"
      muenCreatePolicySrc $1
    packageScript: |
      muenPackagePolicySrc $1
      cp $1/test_hello.muen .

  policy:
    inherit: [python3]
    depends:
      - bsp::intel::microcode
      - muen::linux-image
      - muen::component-libs-muinit
      - muen::components-ahci_drv
      - muen::components-controller
      - muen::components-dbgserver
      - muen::components-dm
      - muen::components-example
      - muen::components-idle
      - muen::components-isolation_tests
      - muen::components-isolation_tests_monitor
      - muen::components-ps2_drv
      - muen::components-sl
      - muen::components-sm
      - muen::components-time
      - muen::components-vt

      - ${MUEN_POLICY_SRC}

      - muen::x86-systems-linux-component-spec

      - name: demo::rootfs
        environment:
          ROOTFS_ARCH: "x86_64"

      - muen::tools-libmupy
      - name: python::lxml
        tools:
          target-toolchain: host-compat-toolchain
      - name: utils::iucode-tool
        use: [tools]
        tools:
          target-toolchain: host-compat-toolchain
    buildTools:
      - acpica
      - iucode-tool
      - linux-gencspec
      - mucfgalloc
      - mucfgcjoin
      - mucfgexpand
      - mucfgucode
      - mucfgvresalloc
      - muxmlfilter
      - mugenspec
      - mugensolo5
      - mugenzp
      - mugenmsrstore
      - mugenacpi
      - mucfgvalidate
    buildVars: [SYSTEM, HARDWARE, PLATFORM, MUEN_POLICY_SRC]
    buildScript: |
      # build the linux cspecs
      linux-gencspec \
        ${BOB_DEP_PATHS[muen::linux-image]}/boot/bzImage \
        ${BOB_DEP_PATHS[muen::x86-systems-linux-component-spec]}/linux.xml \
        --out_spec linux.xml \
        --src_policy ${BOB_DEP_PATHS[$MUEN_POLICY_SRC]}/${SYSTEM}.xml
      # --initramfs ${BOB_DEP_PATHS[demo::rootfs]}/boot/initramfs.cpio.gz \

      CSPECS="$(pwd)/linux.xml"
      # collect dependencies cspecs
      for dep_name in ${!BOB_DEP_PATHS[@]}; do
        dep_dir=${BOB_DEP_PATHS[${dep_name}]}
        if [[ -e ${dep_dir}/.bob/cspecs ]]; then
          CSPECS+=${CSPECS:+,}${dep_dir}/$(cat ${dep_dir}/.bob/cspecs)
        fi
      done
      # Join
      mucfgcjoin -i ${BOB_DEP_PATHS[$MUEN_POLICY_SRC]}/${SYSTEM}.xml \
        -o ${SYSTEM}_with_comp.xml \
        -c ${CSPECS}

      # Allocate virtual memory
      mucfgvresalloc ${SYSTEM}_with_comp.xml ${SYSTEM}_va.xml

      # Filter to core schema
      muxmlfilter -isn Format_Src_Ext -osn Format_Src ${SYSTEM}_va.xml \
        ${SYSTEM}_with_va_filtered.xml

      # MCU
      mucfgucode -i ${SYSTEM}_with_va_filtered.xml \
        -u ${BOB_DEP_PATHS['bsp::intel::microcode']} -o .

      # Expand
      mucfgexpand ${SYSTEM}_with_va_filtered.xml ${SYSTEM}_a.xml

      # Allocate physical memory
      mucfgalloc ${SYSTEM}_a.xml ${SYSTEM}_b.xml

      # Validate
      mucfgvalidate ${SYSTEM}_b.xml

      GENERATORS=(mugenspec mugensolo5 mugenzp mugenmsrstore mugenacpi)
      for G in ${GENERATORS[@]}; do
        $G -o  $(pwd) ${SYSTEM}_b.xml
      done

    provideDeps: ['*']
    packageScript: |
      rsync -a --delete $1/ .
      echo "GPR_PROJECT_PATH=." >> .gpr_project
