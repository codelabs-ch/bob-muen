inherit: [muen-root]

environment:
  MUEN_POLICY_SRC: "muen::x86-kernel-policy-src"
  LINUX_CUSTOM_CONFIG: "muen::x86-kernel-linux-config"
  LINUX_CONFIG: "linux64-6.1"

depends:
  - name: libs::glib-tools
    use: [tools]
    forward: True
  - name: utils::cpio
    use: [tools]
    forward: True
  - name: utils::gnupg
    use: [tools]
  - name: utils::xorriso
    use: [tools]
  - name: bsp::grub2-tools
    use: [tools]
  - name: utils::mtools
    use: [tools]

  - name: muen::tau0-static
    tools:
      target-toolchain: host-compat-gnat-toolchain
    use: [tools]

  # kernel metric
  - name: adacore::libadalang-tools
    use: [tools]
    forward: True
    tools:
      target-toolchain: host-compat-gnat-toolchain

  # build an x86_64 linux gnu compiler with ada enabled
  - name: devel::cross-toolchain-x86_64-linux-gnu-ada
    use: [tools]
    forward: True
    tools:
      target-toolchain: host-compat-gnat-toolchain
      host-native-toolchain: host-compat-gnat-toolchain

multiPackage:
  qemu:
    environment:
      SYSTEM: "demo_system_vtd"
      HARDWARE: "qemu-kvm"
      ADDITIONAL_HW: "common_hardware"
      PLATFORM: "qemu-kvm"
    multiPackage: &muen_build_mode
      debug: &image_common
        environment:
          MUEN_BUILD_MODE: "debug"
        depends:
          # required for nci x86
          - name: muen::tools-mulog

          - ${SBS_KEYS_PKG:-muen::sbs-keys}

          - bsp::grub2
          - muen::x86-kernel-grub-cfg

          - environment:
              RTS: "muen::rts"
            depends:
              - muen::x86-kernel
        buildTools:
          - mucheckelf
          - mucfgmemhashes
          - mugensinfo
          - mugentau0cmds
          - tau0
          - sbs_tools
          - gnupg
          - grub2-tools
          - xorriso
          - mtools
        buildVars: [SYSTEM, SBS_KEYS_PKG, GRUB2_PLATFORM, GRUB2_TARGET, ARCH]
        buildScript: |
          DEPS=""
          for d in ${!BOB_DEP_PATHS[@]}; do
            echo $d
            DIR=${BOB_DEP_PATHS[$d]}
            DEPS+=":${DIR}"
            if [ -e ${DIR}/kernel ]; then
              echo "kernel found in: ${DIR}"
            fi
            if [ -d ${DIR}/usr/bin ]; then
              DEPS+=":${DIR}/usr/bin"
              if [ -e ${DIR}/usr/bin/kernel ]; then
                echo "kernel found in: ${DIR}/usr/bin"
              fi
            fi
            if [ -e ${DIR}/boot ]; then
              DEPS+=":${DIR}/boot"

              if [ -e ${DIR}/boot/kernel ]; then
                echo "kernel found in: ${DIR}/boot"
              fi
            fi
          done

          mucheckelf ${BOB_DEP_PATHS[muen::x86-kernel-policy]}/${SYSTEM}_b.xml \
            ${BOB_DEP_PATHS[muen::x86-kernel]}/.debug/kernel

          mucfgmemhashes -i ${DEPS} \
            ${BOB_DEP_PATHS[muen::x86-kernel-policy]}/${SYSTEM}_b.xml \
            ${SYSTEM}_b.xml

          mugensinfo -o $(pwd) \
            ${SYSTEM}_b.xml

          mugentau0cmds \
            ${SYSTEM}_b.xml \
            ${SYSTEM}_b_cmds.xml

          tau0_main -i ${DEPS}:$(pwd) -o $(pwd) -n muen.img ${SYSTEM}_b_cmds.xml

          keydir=$(mktemp -d)
          trap "rm -rf $keydir" EXIT

          cp -r ${BOB_DEP_PATHS[${SBS_KEYS_PKG:-muen::sbs-keys}]}/* $keydir
          chmod 700 $keydir

          sbs_create -k $keydir -i muen.img.cmds -o muen.sbs
          sbs_inspect -i muen.sbs

          MUEN_EFI="false"
          if [[ ${GRUB2_PLATFORM:-efi} == efi ]]; then
            GRUB_CFG=grub.cfg.efi
          else
            GRUB_CFG=grub.cfg
          fi

          GRUB2_MODS_PATH="usr/lib/grub/${GRUB2_TARGET:-ARCH}-${GRUB2_PLATFORM:-efi}"

          # create signatures
          rm -f ${GRUB_CFG}.sig
          gpg --batch --digest-algo SHA512 -b --homedir $keydir \
              -o ${GRUB_CFG}.sig \
              ${BOB_DEP_PATHS[muen::x86-kernel-grub-cfg]}/${GRUB_CFG}

          rm -rf $keydir
          pkgdatadir=${BOB_DEP_PATHS['bsp::grub2']}/usr/share/grub/ \
          grub-mkrescue -d ${BOB_DEP_PATHS['bsp::grub2']}/${GRUB2_MODS_PATH} \
            --modules="gcry_rsa gcry_sha512 configfile csl pgp sbs normal part_msdos ext2 configfile normal" \
            --pubkey ${BOB_DEP_PATHS[muen::x86-kernel-grub-cfg]}/keys/testkey.pub \
            -o muen.iso \
            -v \
            boot/grub/grub.cfg=${BOB_DEP_PATHS[muen::x86-kernel-grub-cfg]}/${GRUB_CFG} \
            boot/grub/grub.cfg.sig=${GRUB_CFG}.sig \
            boot/kernel.csl=muen.img.cmds \
            boot/kernel.sbs=muen.sbs \
            boot/filo/menu.lst=${BOB_DEP_PATHS[muen::x86-kernel-grub-cfg]}/menu.lst

        packageScript: |
          cp $1/muen.iso .
      release:
        <<: *image_common
        environment:
          MUEN_BUILD_MODE: "release"
      proof:
        environment:
          MUEN_BUILD_MODE: "prove"
        depends:
          - environment:
              ISR_ENTRIES: "muen::x86-kernel-components-isr_entries"
            depends:
              - muen::common-common-proof
              - muen::common-strings-proof
          - muen::common-libmusinfo-proof

          - muen::x86-kernel-proof

          - if: $(ne,${TAU0_PROOF:-UNSET},UNSET)
            name: muen::tau0-static-proof
            tools:
              target-toolchain: host-compat-gnat-toolchain

          - muen::x86-kernel-components-libmuchannel-proof
          - muen::x86-kernel-components-libmucontrol-proof
          - muen::x86-kernel-components-libmudebuglog-proof
          - muen::x86-kernel-components-libmudm-proof
          # TODO: T767
          # - muen::x86-kernel-components-libmuinit-proof
          - muen::x86-kernel-components-libmutime-proof

          - muen::x86-kernel-components-ahci_drv-proof
          - muen::x86-kernel-components-controller-proof
          - muen::x86-kernel-components-dm-proof
          - muen::x86-kernel-components-example-proof
          - muen::x86-kernel-components-muinit-proof
          - muen::x86-kernel-components-sl-proof
          - muen::x86-kernel-components-sm-proof
          - muen::x86-kernel-components-time-proof
        buildScript: |
          for d in ${!BOB_DEP_PATHS[@]}; do
            dirname=$(echo $d | sed 's/::/-/g')
            mkdir $dirname
            cp ${BOB_DEP_PATHS[$d]}/gnatprove.* $dirname/
          done
        packageScript: |
          rsync -a --delete $1/ .

  qemu-coreboot:
    environment:
      SYSTEM: "demo_system_vtd"
      HARDWARE: "qemu-kvm-coreboot"
      ADDITIONAL_HW: "common_hardware"
      PLATFORM: "qemu-kvm-coreboot"
    multiPackage: *muen_build_mode

  qemu-solo5-test:
    environment:
      SYSTEM: "mirage-solo5"
      HARDWARE: "qemu-kvm"
      ADDITIONAL_HW: "common_hardware"
      PLATFORM: "qemu-kvm"
      MUEN_POLICY_SRC: "muen::x86-kernel-policy-src-solo5-test"
    multiPackage: *muen_build_mode

  qemu-unipi:
    environment:
      SYSTEM: "mirage-solo5"
      HARDWARE: "qemu-kvm"
      ADDITIONAL_HW: "common_hardware"
      PLATFORM: "qemu-kvm"
      MUEN_POLICY_SRC: "muen::x86-kernel-policy-src-mirage-solo5"
      LINUX_CUSTOM_CONFIG: "muen::x86-kernel-linux-config-unipi"
    multiPackage: *muen_build_mode

  nuc5i5myhe-unipi:
    environment:
      SYSTEM: "mirage-solo5"
      HARDWARE: "intel-nuc-5i5myhe"
      ADDITIONAL_HW: "common_hardware"
      PLATFORM: "intel-nuc-5i5myhe"
      MUEN_POLICY_SRC: "muen::x86-kernel-policy-src-mirage-solo5"
      LINUX_CUSTOM_CONFIG: "muen::x86-kernel-linux-config-unipi"
      ROOTFS_OVERLAYS: "unipi/"
    multiPackage: *muen_build_mode

  nuc6cayh-efi-integ:
    environment:
      SYSTEM: "integration_tests"
      HARDWARE: "intel-nuc-6cayh"
      ADDITIONAL_HW: "common_hardware"
      PLATFORM: "intel-nuc-6cayh"
      GRUB2_TARGET: "x86_64"
      GRUB2_PLATFORM: "efi"
    multiPackage: *muen_build_mode

  ktqm77-integ:
    environment:
      SYSTEM: "integration_tests_kt"
      HARDWARE: "kontron-ktqm77"
      ADDITIONAL_HW: "common_hardware"
      PLATFORM: "kontron-ktqm77"
    multiPackage:
      <<: *muen_build_mode
      metrics:
        environment:
          MUEN_BUILD_MODE: "release"
        depends:
          - environment:
              RTS: "muen::rts"
            depends:
              - muen::x86-kernel-metrics
        buildScript: |
          for d in ${!BOB_DEP_PATHS[@]}; do
            dirname=$(echo $d | sed 's/::/-/g')
            mkdir $dirname
            cp ${BOB_DEP_PATHS[$d]}/gnatmetric.log $dirname/
          done
        packageScript: |
          rsync -a --delete $1/ .

  t430s:
    environment:
      SYSTEM: "demo_system_vtd"
      HARDWARE: "lenovo-t430s"
      ADDITIONAL_HW: "common_hardware"
      PLATFORM: "lenovo-t430s"
    multiPackage: *muen_build_mode
